# Спецификация: Санитизация Markdown для Telegram API

## Обзор

Проблема: LLM иногда возвращает некорректный или ломаный markdown, который может вызывать ошибки при отправке через Telegram API или отображаться некорректно. Необходимо создать надежный механизм санитизации markdown перед отправкой.

## Требования

### Функциональные требования

1. **Валидация Markdown**
   - Проверка синтаксической корректности markdown
   - Обнаружение незакрытых тегов форматирования
   - Проверка баланса скобок и кавычек

2. **Исправление ошибок**
   - Автоматическое закрытие незакрытых тегов
   - Экранирование спецсимволов, которые могут ломать разметку
   - Исправление некорректных вложенностей форматирования

3. **Поддержка Telegram Markdown**
   - Поддержка **bold**, *italic*, `code`, __underline__, ~strikethrough~
   - Поддержка [ссылок](URL) и ```code blocks```
   - Экранирование символов: `_ * [ ] ( ) ~ ` > # + - = | { } . !`

### Нефункциональные требования

1. **Надежность**
   - Никогда не должны возвращать markdown, который сломает Telegram API
   - Graceful fallback к plain text если修复 невозможен
   - Обработка всех edge cases

2. **Производительность**
   - Минимальная задержка при обработке
   - Эффективная работа с текстами до 4096 символов

3. **Безопасность**
   - Предотвращение XSS через markdown
   - Фильтрация потенциально опасного контента

## Архитектура

### Компоненты

#### 1. TelegramMarkdownSanitizer (основной класс)
```ruby
class TelegramMarkdownSanitizer
  def initialize(options = {})
    @commonmarker_options = options[:commonmarker] || default_options
  end

  def sanitize(text)
    # Основной метод санитизации
  end

  private

  def valid_telegram_markdown?(text)
    # Проверка корректности markdown для Telegram
  end

  def fix_unclosed_tags(text)
    # Закрытие незакрытых тегов
  end

  def escape_special_chars(text)
    # Экранирование спецсимволов
  end
end
```

#### 2. MarkdownValidator (валидатор)
```ruby
class MarkdownValidator
  def valid?(text)
    # Проверка валидности markdown для Telegram
  end

  def find_errors(text)
    # Поиск конкретных ошибок в markdown
  end
end
```

#### 3. MarkdownFixer (исправитель)
```ruby
class MarkdownFixer
  def fix_unclosed_tags(text)
    # Закрытие незакрытых тегов
  end

  def fix_nested_formatting(text)
    # Исправление вложенного форматирования
  end

  def escape_problematic_chars(text)
    # Экранирование проблемных символов
  end
end
```

### Интеграция с существующей системой

1. **Модификация LLMClient**
   - Добавление санитизации перед отправкой в TelegramBotHandler
   - Опциональное логирование оригинального и исправленного текста

2. **Обработка в TelegramBotHandler**
   - Применение санитизации ко всем исходящим сообщениям
   - Fallback на plain_text если markdown невалидный

## Правила обработки Markdown

### 1. Telegram Markdown поддерживает:
- `*italic*` или `_italic_`
- `**bold**` или `__bold__`
- `__underline__`
- `~strikethrough~`
- `` `code` ``
- ```code block```
- `[link](URL)`

### 2. Частые проблемы LLM:
- Незакрытые теги: `**bold текст без закрывающих звездочек`
- Вложенные теги: `**_nested formatting_**`
- Пробелы в неправильных местах: `* *italic* *`
- Слишком длинные строки без пробелов
- Спецсимволы в тексте: `5 * 5 = 25`

### 3. Стратегия исправления:
1. Проверить баланс открывающих/закрывающих тегов
2. Исправить незакрытые теги добавлением закрывающих
3. Экранировать спецсимволы вне тегов форматирования
4. Разбить длинные слова (> 15 символов) для предотвращения проблем
5. Валидировать финальный результат

## Тестовые кейсы

### Примеры некорректного markdown от LLM:
1. `"Привет! **Это bold текст без закрывающих тегов"`
2. `"Цена: *500 рублей* (скидка *10%*)"`
3. `"Ссылка: [некорректная ссылка](url без пробелов)"`
4. `"`Код: `function() { return }` (незакрытый)"`
5. `"Список:\n* Пункт 1\n* Пункт 2 (без закрывающей звездочки)"`

### Ожидаемые результаты:
1. `"Привет! **Это bold текст без закрывающих тегов**"`
2. `"Цена: *500 рублей* (скидка 10\%)"`
3. `"Ссылка: [некорректная ссылка](url без пробелов)"` или экранирование
4. `"Код: `function() { return }`"`
5. `"Список:\n* Пункт 1\n* Пункт 2*"`

## План имплементации

1. Добавить commonmarker gem в Gemfile
2. Создать класс `TelegramMarkdownSanitizer` с базовыми методами
3. Реализовать валидацию через commonmarker + regex
4. Реализовать исправление незакрытых тегов
5. Реализовать экранирование спецсимволов
6. Добавить тесты для всех кейсов
7. Интегрировать в `LLMClient` и `TelegramBotHandler`
8. Провести комплексное тестирование с реальными LLM ответами

## Критерии успеха

1. ✅ Все сообщения от LLM успешно отправляются через Telegram API
2. ✅ Markdown отображается корректно в Telegram
3. ✅ Никаких fallback'ов на plain text без необходимости
4. ✅ Производительность не ухудшилась (задержка < 50ms)
5. ✅ 100% покрытие тестами edge cases

## Файлы для изменения/создания

- `Gemfile` - добавить commonmarker
- `lib/telegram_markdown_sanitizer.rb` - новый основной класс
- `lib/llm_client.rb` - модификация для интеграции санитизации
- `lib/telegram_bot_handler.rb` - модификация для fallback
- `test/telegram_markdown_sanitizer_test.rb` - новый
- `test/integration/markdown_telegram_integration_test.rb` - новый

## Зависимости

### Обязательные:
- `commonmarker` - для парсинга и валидации markdown

### Опциональные:
- `htmlentities` - для экранирования HTML сущностей
- Собственные regex для Telegram-специфичной логики