# Спецификация: Команда /reset

## Обзор
Команда `/reset` должна полностью очищать историю диалога пользователя и начинать новый разговор с нуля, аналогично команде `/start`, но без отображения приветственного сообщения.

## Текущая архитектура

### Управление историей диалогов
- **ConversationManager** управляет историей через базу данных
- История хранится в таблицах `Chat` и `Message`
- Метод `clear_history(user_id)` уже реализован в `ConversationManager`

### Обработка команд
- Команда `/start` уже реализована в `TelegramBotHandler#process_message` (строки 204-215)
- `/start` очищает историю и отправляет приветственное сообщение из `AppConfig.welcome_message`

## Требования к реализации

### Функциональность
1. **Распознавание команды**: Бот должен реагировать на текст `/reset`
2. **Очистка истории**: Вызывать `ConversationManager#clear_history(user_id)`
3. **Подтверждение**: Отправлять пользователю сообщение о сбросе диалога
4. **Безопасность**: Команда должна быть доступна только в личных сообщениях с ботом

### Поведение
- Пользователь отправляет `/reset`
- Бот очищает всю историю сообщений для данного пользователя
- Бот отправляет подтверждение сброса диалога
- Новый диалог начинается с чистого листа

### Сообщения пользователю
- **Подтверждение сброса**: "✅ Диалог сброшен. Можем начать разговор заново!"
- **Ошибка**: (если не удалось очистить) "❌ Не удалось сбросить диалог. Попробуйте позже."

## Место в коде

### TelegramBotHandler#process_message
Добавить обработку команды `/reset` после обработки `/start` (после строки 215):

```ruby
# Handle /reset command
if text && text.start_with?('/reset')
  Application.logger.info "User #{user_id} issued /reset command"

  if @conversation_manager.clear_history(user_id)
    bot.api.send_message(
      chat_id: chat_id,
      text: '✅ Диалог сброшен. Можем начать разговор заново!',
      parse_mode: 'Markdown'
    )
  else
    bot.api.send_message(
      chat_id: chat_id,
      text: '❌ Не удалось сбросить диалог. Попробуйте позже.',
      parse_mode: 'Markdown'
    )
  end
  return
end
```

## Взаимодействия с компонентами

### ConversationManager
- Использовать существующий метод `clear_history(user_id)`
- Метод возвращает `true` при успехе, `false` при ошибке

### TelegramBotHandler
- Добавить проверку команды `/reset`
- Вызвать `ConversationManager#clear_history`
- Отправить соответствующее сообщение пользователю
- Логировать операцию сброса

### Логирование
- Успешный сброс: `"User #{user_id} issued /reset command - success"`
- Ошибка: `"User #{user_id} issued /reset command - failed"`

## Тестирование

### Модульные тесты
1. **Тест распознавания команды**: Проверить, что `/reset` распознается
2. **Тест очистки истории**: Проверить вызов `clear_history`
3. **Тест ответа пользователю**: Проверить отправку подтверждения
4. **Тест обработки ошибок**: Проверить поведение при ошибке очистки

### Интеграционные тесты
1. **Полный цикл**: Создать историю → отправить `/reset` → проверить очистку
2. **Несколько пользователей**: Проверить независимость сброса для разных пользователей
3. **Продолжение диалога**: После сброса проверить начало нового диалога

## Обработка ошибок

### Возможные ошибки
1. **Ошибка базы данных**: При удалении сообщений
2. **Отсутствие пользователя**: Если пользователь не найден в системе
3. **Ошибка API Telegram**: При отправке ответного сообщения

### Стратегии обработки
- Логирование ошибки в `Application.logger.error`
- Отправка сообщения об ошибке пользователю
- Продолжение работы бота (не падение приложения)

## Безопасность

### Ограничения
- Команда доступна только в личных сообщениях
- Нет дополнительных прав доступа (доступна всем пользователям)
- Очистка только истории текущего пользователя

### Защита от злоупотреблений
- Использовать существующий `RateLimiter` для ограничения частоты команд
- Логирование всех операций сброса для аудита

## Расширения (будущие версии)

### Возможные улучшения
1. **Подтверждение действия**: Требовать подтверждение перед сбросом
2. **Выборочная очистка**: Позволить выбрать, что именно сбросить
3. **Резервное копирование**: Сохранять историю перед очисткой
4. **Статистика**: Показывать количество удаленных сообщений

### Новые команды
- `/reset confirm` - подтверждение сброса
- `/history clear` - альтернативный синтаксис
- `/history stats` - статистика перед очисткой

## Влияние на существующий код

### Совместимость
- Не затрагивает существующую функциональность
- Использует существующие методы `ConversationManager`
- Следует существующим паттернам обработки команд

### Производительность
- Минимальное влияние на производительность
- Очистка истории может занять время при большом количестве сообщений
- Рассмотреть асинхронное выполнение для больших историй