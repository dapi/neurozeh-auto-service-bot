# План имплементации: Консоль приложения (IRB)

## Анализ текущей архитектуры

Перед созданием консоли необходимо изучить текущую структуру проекта для правильной интеграции:

### Изучаемые компоненты:
1. **Структура приложения** - основные директории и файлы
2. **Конфигурация** - как работает AppConfig
3. **Зависимости** - какие gem'ы используются
4. **Инициализация** - как запускается приложение

## Этап 1: Исследование и подготовка (1-2 часа)

### 1.1 Изучение текущей архитектуры
- [ ] Проанализировать структуру директорий `lib/`
- [ ] Изучить `config/application.rb` и процесс загрузки
- [ ] Понять, как инициализируются основные компоненты
- [ ] Проверить текущие зависимости в Gemfile

### 1.2 Изучение IRB и similar проектов
- [ ] Изучить документацию IRB для кастомизации
- [ ] Посмотреть как реализована консоль в Rails (если возможно)
- [ ] Изучить best practices для Ruby консолей

### 1.3 Подготовка окружения
- [ ] Проверить текущую версию Ruby и IRB
- [ ] Убедиться, что все зависимости корректно загружаются
- [ ] Создать базовую структуру для консольных файлов

## Этап 2: Базовая реализация консоли (2-3 часа)

### 2.1 Создание исполняемого файла
- [ ] Создать `bin/console` с правильными правами доступа
- [ ] Реализовать базовый запуск IRB
- [ ] Добавить обработку аргументов командной строки

**`bin/console`:**
```ruby
#!/usr/bin/env ruby
require_relative '../lib/console'
Console.start(ARGV)
```

### 2.2 Основной класс консоли
- [ ] Создать `lib/console.rb`
- [ ] Реализовать базовый запуск IRB с загрузкой приложения
- [ ] Настроить окружение консоли

**`lib/console.rb`:**
```ruby
require 'irb'
require_relative '../config/environment'

module Console
  def self.start(args = [])
    # Загрузка приложения
    # Настройка IRB
    # Запуск сессии
  end
end
```

### 2.3 Интеграция с приложением
- [ ] Обеспечить загрузку всех необходимых файлов
- [ ] Проверить работу конфигурации
- [ ] Убедиться, что все зависимости доступны

## Этап 3: Интеграция с компонентами приложения (2-3 часа)

### 3.1 Доступ к основным объектам
- [ ] Сделать доступными экземпляры основных классов
- [ ] Настроить правильную инициализацию объектов
- [ ] Обеспечить доступ к конфигурации

**Объекты для доступа:**
- `bot` - TelegramBotHandler
- `llm_client` - LLMClient
- `conversation_manager` - ConversationManager
- `rate_limiter` - RateLimiter
- `config` - AppConfig
- `logger` - логгер приложения

### 3.2 Безопасная инициализация
- [ ] Проверить наличие необходимых токенов и настроек
- [ ] Обработать ошибки инициализации
- [ ] Предоставить информативные сообщения об ошибках

### 3.3 Вспомогательные методы
- [ ] Создать `lib/console/helpers.rb`
- [ ] Добавить удобные методы для работы с компонентами
- [ ] Реализовать методы для отладки

## Этап 4: Режим песочницы (2 часа)

### 4.1 Создание класса песочницы
- [ ] Создать `lib/console/sandbox.rb`
- [ ] Реализовать мокирование реальных API вызовов
- [ ] Настроить безопасное окружение

### 4.2 Интеграция песочницы
- [ ] Добавить флаг `--sandbox` в командную строку
- [ ] Реализовать переключение режимов
- [ ] Обеспечить изоляцию от реальных данных

**Пример реализации:**
```ruby
# В режиме песочницы
bot = SandboxBot.new  # моковый бот
llm_client = MockLLMClient.new  # моковый LLM клиент
```

### 4.3 Тестирование песочницы
- [ ] Проверить, что песочница не делает реальных запросов
- [ ] Убедиться, что все моки работают корректно
- [ ] Проверить безопасность режима

## Этап 5: Улучшение пользовательского опыта (1-2 часа)

### 5.1 Настройка IRB
- [ ] Настроить подсветку синтаксиса
- [ ] Настроить форматирование вывода
- [ ] Добавить приветственное сообщение

### 5.2 История команд
- [ ] Настроить сохранение истории команд
- [ ] Обеспечить работу history across sessions
- [ ] Добавить навигацию по истории

### 5.3 Полезные команды
- [ ] Добавить команду `help` для доступных объектов
- [ ] Создать команду `reload` для перезагрузки приложения
- [ ] Добавить команду `env` для показа текущего окружения

## Этап 6: Интеграция с Rake и документация (1 час)

### 6.1 Rake task
- [ ] Добавить `task :console` в Rakefile
- [ ] Обеспечить запуск через `rake console`
- [ ] Синхронизировать с `bin/console`

### 6.2 Документация
- [ ] Обновить README.md с инструкциями по использованию консоли
- [ ] Добавить примеры использования
- [ ] Создать справку по доступным командам

## Этап 7: Тестирование (2-3 часа)

### 7.1 Юнит-тесты
- [ ] Создать `test/test_console.rb`
- [ ] Тестировать запуск консоли
- [ ] Тестировать доступность объектов
- [ ] Тестировать режим песочницы

### 7.2 Интеграционные тесты
- [ ] Тестировать взаимодействие с реальными компонентами
- [ ] Проверять конфигурацию окружения
- [ ] Тестировать обработку ошибок

### 7.3 Ручное тестирование
- [ ] Проверить запуск в разных режимах
- [ ] Протестировать работу с основными объектами
- [ ] Проверить удобство использования

## Этап 8: Финализация и рефакторинг (1 час)

### 8.1 Код-ревью и рефакторинг
- [ ] Просмотреть код на соответствие стандартам
- [ ] Оптимизировать производительность загрузки
- [ ] Улучшить обработку ошибок

### 8.2 Финальная проверка
- [ ] Проверить все критерии приемки
- [ ] Убедиться в отсутствии багов
- [ ] Подготовить к использованию в команде

## Необходимые ресурсы

### Время: 12-17 часов
### Файлы для создания/изменения:
- `bin/console` (новый)
- `lib/console.rb` (новый)
- `lib/console/helpers.rb` (новый)
- `lib/console/sandbox.rb` (новый)
- `Rakefile` (изменить)
- `README.md` (изменить)
- `test/test_console.rb` (новый)

### Зависимости:
- `irb` (стандартная библиотека)
- Возможные дополнительные gem'ы для улучшения IRB опыта

## Риски и митигация

### Риск 1: Проблемы с загрузкой зависимостей
- **Митигация:** Постепенная загрузка и обработка ошибок

### Риск 2: Сложность интеграции с текущей архитектурой
- **Митигация:** Тщательное изучение кода перед реализацией

### Риск 3: Безопасность в режиме песочницы
- **Митигация:** Тестирование изоляции и мокирования

## Критерии завершения

1. ✅ Консоль запускается и работает
2. ✅ Все основные объекты доступны
3. ✅ Режим песочницы работает безопасно
4. ✅ Есть тесты
5. ✅ Документация обновлена
6. ✅ Интеграция с Rake работает
7. ✅ Код соответствует стандартам проекта