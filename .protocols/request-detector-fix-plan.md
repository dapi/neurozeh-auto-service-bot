# План обеспечения валидного возврата из RequestDetector

## Проблема
RequestDetector выбрасывает исключения, которые не обрабатываются в ruby_llm `handle_tool_calls`, что приводит к:
1. Созданию tool_call без соответствующего tool response
2. Ошибке LLM API при следующем запросе: "assistant message with 'tool_calls' must be followed by tool messages"

## 1. Анализ возможных точек исключений

Изучаю код RequestDetector и выявляю места где могут возникнуть исключения:

1. **`send_to_admin_chat` (линия 69)**:
   - `format_admin_notification` - ошибки форматирования строк
   - `Telegram::Bot::Client.new` - проблемы с токеном
   - `bot.api.send_message` - network ошибки, ошибки API, недоступность

2. **Вспомогательные методы форматирования**:
   - `format_basic_info`, `format_car_info`, etc. - ошибки при работе с данными
   - Преобразования типов данных - если данные не соответствуют ожиданиям

3. **Конфигурационные проблемы**:
   - `AppConfig.admin_chat_id` может быть nil
   - `AppConfig.telegram_bot_token` может быть невалидным

## 2. Стратегия защиты

**Основной принцип**: RequestDetector должен НИКОГДА не выбрасывать исключения наверх. Все ошибки должны ловиться внутри и преобразовываться в валидный ответ.

**Уровни защиты**:

### Уровень A - Внешняя защита (execute method)
```ruby
def execute(...)
  begin
    # основной код
  rescue => e
    Application.logger.error "RequestDetector error: #{e.message}"
    { error: "Ошибка при обработке заявки" }
  end
end
```

### Уровень B - Защита критических операций
- Защита `send_to_admin_chat`
- Защита форматирования
- Валидация входных данных

### Уровень C - Защита форматирования
- Безопасная работа с nil/пустыми значениями
- Защита типов данных

## 3. Конкретные улучшения

### A. Улучшение `execute` method:
- Добавить валидацию `admin_chat_id`
- Добавить общую защиту от всех исключений
- Гарантировать возврат строки или `{error: "..."}`
- Логировать все ошибки для отладки

### B. Улучшение `send_to_admin_chat`:
- Защита от ошибок Telegram API
- Валидация admin_chat_id
- Обработка network ошибок

### C. Улучшение методов форматирования:
- Безопасная работа с хэшами и массивами
- Защита от nil значений
- Валидация типов

### D. Улучшение инициализации:
- Безопасная работа с `@enriched_data`

## 4. Ожидаемый результат

После исправлений RequestDetector будет:
- **Надежным**: никогда не выбросит исключение наверх
- **Предсказуемым**: всегда возвращает валидный результат
- **Отлаживаемым**: подробно логирует ошибки
- **Устойчивым**: корректно обрабатывает проблемы с внешними сервисами

Это гарантирует, что ruby_llm всегда сможет создать tool response сообщение, даже если заявка не удастся отправить.

## 5. Порядок реализации

1. **Критичные**: Исправить `execute` method (уровень A)
2. **Важные**: Исправить `send_to_admin_chat` (уровень B)
3. **Желательные**: Улучшить методы форматирования (уровень C)
4. **Тестирование**: Проверить все сценарии ошибок

## 6. Тестовые сценарии

- Отсутствие `admin_chat_id`
- Невалидный `telegram_bot_token`
- Network ошибки при отправке в Telegram
- Ошибки форматирования при некорректных данных
- Пустые или nil значения в параметрах