# План имплементации: Санитизация Markdown для Telegram API

## Обзор
Создание надежной системы очистки markdown от LLM перед отправкой в Telegram API с использованием commonmarker gem.

## Этапы реализации

### Этап 1: Подготовка зависимостей
1. **Добавить commonmarker gem в Gemfile**
   - `gem 'commonmarker'`
   - Выполнить `bundle install`
   - Проверить совместимость с текущими gem

### Этап 2: Создание основного класса
2. **Создать базовый класс TelegramMarkdownSanitizer**
   - Файл: `lib/telegram_markdown_sanitizer.rb`
   - Основной метод `sanitize(text)`
   - Обработка ошибок и fallback
   - Конфигурация commonmarker

3. **Реализовать метод базовой валидации markdown**
   - Проверка баланса тегов: `**`, `*`, `` ` ``
   - Валидация ссылок: `[text](url)`
   - Проверка корректности вложенности
   - Использование commonmarker для парсинга

4. **Реализовать метод исправления незакрытых тегов**
   - Автоматическое закрытие незакрытых `**bold**`
   - Закрытие незакрытых `*italic*`
   - Закрытие незакрытых `` `code` ``
   - Исправление некорректных ссылок

5. **Реализовать метод экранирования спецсимволов**
   - Экранирование символов вне тегов: `_ * ~ [ ] ( )`
   - Обработка спецсимволов в математических выражениях
   - Экранирование потенциально опасного контента

### Этап 3: Тестирование
6. **Создать тесты для TelegramMarkdownSanitizer**
   - Файл: `test/telegram_markdown_sanitizer_test.rb`
   - Тесты на корректный markdown (должен остаться без изменений)
   - Тесты на некорректный markdown (должен исправиться)
   - Тесты на edge cases и boundary conditions
   - Тесты производительности

### Этап 4: Интеграция
7. **Интегрировать санитизацию в LLMClient**
   - Модификация `lib/llm_client.rb`
   - Добавление вызова санитизации перед отправкой
   - Опциональное логирование оригинального/исправленного текста
   - Обработка ошибок санитизации

8. **Добавить обработку fallback в TelegramBotHandler**
   - Модификация `lib/telegram_bot_handler.rb`
   - Проверка формата (markdown vs plain_text)
   - Дополнительная валидация перед отправкой
   - Автопереключение на plain_text при необходимости

### Этап 5: Комплексное тестирование
9. **Создать интеграционные тесты**
   - Файл: `test/integration/markdown_telegram_integration_test.rb`
   - Тестирование полного цикла: LLM -> санитизация -> Telegram
   - Тестирование с различными типами контента
   - Нагрузочное тестирование

10. **Протестировать с реальными LLM ответами**
    - Запуск бота с логированием markdown
    - Сбор реальных кейсов от LLM
    - Проверка обработки на собранных данных
    - Оптимизация правилsanitизации

## Технические детали

### Структура классов:
```ruby
class TelegramMarkdownSanitizer
  def initialize(options = {})
    @commonmarker_options = options[:commonmarker] || default_options
  end

  def sanitize(text)
    # Основной метод санитизации
  end

  private

  def valid_telegram_markdown?(text)
    # Валидация для Telegram
  end

  def fix_unclosed_tags(text)
    # Исправление незакрытых тегов
  end

  def escape_special_chars(text)
    # Экранирование спецсимволов
  end
end
```

### Правила валидации:
1. **Баланс тегов**: количество открывающих и закрывающих символов должно быть четным
2. **Корректность ссылок**: `[text](url)` где url начинается с http/https
3. **Длина строк**: не более 4096 символов для Telegram
4. **Запрещенные символы**: экранирование вне тегов форматирования

### Fallback стратегия:
1. При ошибке парсинга → экранировать все markdown символы
2. При ошибке исправления → plain text
3. При превышении длины → обрезание с эллипсом

## Критерии успеха

- ✅ Все markdown сообщения от LLM успешно отправляются в Telegram
- ✅ Сохраняется форматирование там где это возможно
- ✅ Нет ошибок Telegram API связанных с markdown
- ✅ Производительность: добавление не более 50ms к времени ответа
- ✅ Покрытие тестами > 95%

## Риски и митигация

1. **Риск**: CommonMarker может быть избыточным для простых кейсов
   **Митигация**: Реализация fallback на простые regex

2. **Риск**: Потеря форматирования при агрессивной санитизации
   **Митигация**: Консервативный подход с максимальным сохранением

3. **Риск**: Регрессии в существующем функционале
   **Митигация**: Постепенное внедрение с обширным тестированием

## Сроки
- **Этапы 1-2**: 1-2 дня
- **Этап 3**: 1 день
- **Этапы 4-5**: 1-2 дня
- **Всего**: 3-5 дней