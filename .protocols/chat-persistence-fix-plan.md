# План исправления персистентности чатов

## Проблема
После перехода на базу данных бот забывает все сообщения и разговаривает как будто каждый раз сначала.

## Корневая причина
Неправильная интеграция с RubyLLM персистентностью:
- В моделях `Chat` и `Message` закомментированы `acts_as_chat` и `acts_as_message`
- В `LLMClient` создается новый `RubyLLM.chat` каждый раз без связи с базой
- История не загружается из базы перед отправкой в LLM

## Решение

### Шаг 1: Активировать RubyLLM персистентность
- Раскомментировать `acts_as_chat` в `app/models/chat.rb:4`
- Раскомментировать `acts_as_message` в `app/models/message.rb:4`
- Проверить наличие всех необходимых полей в БД

### Шаг 2: Исправить LLMClient
- Заменить создание нового `RubyLLM.chat` на использование `db_chat.ask()`
- Убрать ручное управление системными инструкциями (использовать `with_instructions` на db_chat)
- Обновить обработку инструментов для работы с ActiveRecord чатом

### Шаг 3: Обновить ConversationManager
- Упростить методы, поскольку RubyLLM будет управлять историей автоматически
- Оставить только вспомогательные методы для статистики и очистки
- Обновить `get_history` для работы с ActiveRecord ассоциациями

### Шаг 4: Тестирование
- Проверить сохранение истории между сессиями
- Убедиться что контекст передается в LLM корректно
- Проверить работу инструментов с новой архитектурой

### Шаг 5: Обновить RequestDetector
- Адаптировать для работы с ActiveRecord моделями
- Убедиться что история диалогов корректно извлекается для анализа

## Файлы для изменения
1. `app/models/chat.rb` - раскомментировать acts_as_chat
2. `app/models/message.rb` - раскомментировать acts_as_message
3. `lib/llm_client.rb` - основной рефакторинг
4. `lib/conversation_manager.rb` - упрощение
5. `lib/request_detector.rb` - адаптация

## Результат
После исправлений бот будет помнить всю историю диалогов и поддерживать контекст между сообщениями.