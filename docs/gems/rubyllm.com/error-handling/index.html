<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="../assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="../assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul:nth-of-type(5) > li:not(:nth-child(3)) > a, .site-nav > ul:nth-of-type(5) > li > ul > li a { background-image: none; } .site-nav > ul:not(:nth-of-type(5)) a, .site-nav li.external a { background-image: none; } .site-nav > ul:nth-of-type(5) > li:nth-child(3) > a { font-weight: 600; text-decoration: none; } .site-nav > ul.nav-category-list > li > button svg, .site-nav > ul:nth-of-type(5) > li:nth-child(3) > button svg { transform: rotate(-90deg); } .site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list, .site-nav > ul:nth-of-type(5) > li.nav-list-item:nth-child(3) > ul.nav-list { display: block; } </style> <script src="../assets/js/vendor/lunr.min.js"></script> <script src="../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="../assets/images/logo.svg" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Error Handling | RubyLLM</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Error Handling" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Learn how to handle errors gracefully when working with AI providers" /> <meta property="og:description" content="Learn how to handle errors gracefully when working with AI providers" /> <link rel="canonical" href="index.html" /> <meta property="og:url" content="https://rubyllm.com/error-handling/" /> <meta property="og:site_name" content="RubyLLM" /> <meta property="og:image" content="https://rubyllm.com/assets/images/og/advanced/error-handling.png" /> <meta property="og:image:height" content="600" /> <meta property="og:image:width" content="1200" /> <meta property="og:image:alt" content="Error Handling" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2025-10-22T09:47:33+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://rubyllm.com/assets/images/og/advanced/error-handling.png" /> <meta name="twitter:image:alt" content="Error Handling" /> <meta property="twitter:title" content="Error Handling" /> <meta name="twitter:site" content="@paolino" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-22T09:47:33+00:00","datePublished":"2025-10-22T09:47:33+00:00","description":"Learn how to handle errors gracefully when working with AI providers","headline":"Error Handling","image":{"width":1200,"height":600,"alt":"Error Handling","url":"https://rubyllm.com/assets/images/og/advanced/error-handling.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rubyllm.com/error-handling/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://rubyllm.com/assets/images/logotype.svg"}},"url":"https://rubyllm.com/error-handling/"}</script> <!-- End Jekyll SEO tag --> <!-- Auto Dark Mode - Must run immediately to prevent flash --> <script src="../assets/js/auto-dark-mode.js"></script> <link rel="icon" type="image/png" href="../assets/images/favicon/favicon-96x96.png" sizes="96x96" /> <link rel="icon" type="image/svg+xml" href="../assets/images/logo.svg" /> <link rel="shortcut icon" href="../assets/images/favicon/favicon.ico" /> <link rel="apple-touch-icon" sizes="180x180" href="../assets/images/favicon/apple-touch-icon.png" /> <meta name="apple-mobile-web-app-title" content="RubyLLM" /> <link rel="manifest" href="../assets/images/favicon/site.webmanifest" /> <!-- Override Twitter card type to use large image --> <meta name="twitter:card" content="summary_large_image"> <script defer data-domain="rubyllm.com" src="https://stats.paolino.me/js/script.outbound-links.js"></script> </head> <body> <a class="skip-to-main" href="index.html#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="../index.html" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="RubyLLM"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="../index.html" class="nav-list-link">Home</a></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/crmne/ruby_llm" class="nav-list-link external" > GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://github.com/crmne/ruby_llm/releases" class="nav-list-link external" > Changelog <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://paolino.me" class="nav-list-link external" > Blog <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> <div class="nav-category">Getting Started</div> <ul class="nav-list"><li class="nav-list-item"><a href="../getting-started/index.html" class="nav-list-link">Getting Started</a></li><li class="nav-list-item"><a href="../overview/index.html" class="nav-list-link">Overview</a></li><li class="nav-list-item"><a href="../configuration/index.html" class="nav-list-link">Configuration</a></li></ul> <div class="nav-category">Core Features</div> <ul class="nav-list"><li class="nav-list-item"><a href="../chat/index.html" class="nav-list-link">Chat</a></li><li class="nav-list-item"><a href="../tools/index.html" class="nav-list-link">Tools</a></li><li class="nav-list-item"><a href="../streaming/index.html" class="nav-list-link">Stream Responses</a></li><li class="nav-list-item"><a href="../embeddings/index.html" class="nav-list-link">Embeddings</a></li><li class="nav-list-item"><a href="../image-generation/index.html" class="nav-list-link">Image Generation</a></li><li class="nav-list-item"><a href="../audio-transcription/index.html" class="nav-list-link">Audio Transcription</a></li><li class="nav-list-item"><a href="../moderation/index.html" class="nav-list-link">Moderation</a></li></ul> <div class="nav-category">Advanced</div> <ul class="nav-list"><li class="nav-list-item"><a href="../rails/index.html" class="nav-list-link">Rails Integration</a></li><li class="nav-list-item"><a href="../async/index.html" class="nav-list-link">Scale with Async</a></li><li class="nav-list-item"><a href="index.html" class="nav-list-link">Error Handling</a></li><li class="nav-list-item"><a href="../models/index.html" class="nav-list-link">Model Registry</a></li><li class="nav-list-item"><a href="../agentic-workflows/index.html" class="nav-list-link">Agentic Workflows</a></li><li class="nav-list-item"><a href="../upgrading/index.html" class="nav-list-link">Upgrading</a></li></ul> <div class="nav-category">Reference</div> <ul class="nav-list"><li class="nav-list-item"><a href="../available-models/index.html" class="nav-list-link">Available Models</a></li><li class="nav-list-item"><a href="../ecosystem/index.html" class="nav-list-link">RubyLLM Ecosystem</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search RubyLLM" aria-label="Search RubyLLM" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 class="no_toc" id="error-handling"> <a href="index.html#error-handling" class="anchor-heading" aria-labelledby="error-handling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Error Handling </h1> <p class="fs-6 fw-300">Learn how to handle errors gracefully when working with AI providers</p> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="index.html#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="index.html#rubyllm-error-hierarchy" id="markdown-toc-rubyllm-error-hierarchy">RubyLLM Error Hierarchy</a></li> <li><a href="index.html#basic-error-handling" id="markdown-toc-basic-error-handling">Basic Error Handling</a></li> <li><a href="index.html#handling-specific-errors" id="markdown-toc-handling-specific-errors">Handling Specific Errors</a></li> <li><a href="index.html#accessing-api-response-details" id="markdown-toc-accessing-api-response-details">Accessing API Response Details</a></li> <li><a href="index.html#error-handling-during-streaming" id="markdown-toc-error-handling-during-streaming">Error Handling During Streaming</a></li> <li><a href="index.html#handling-errors-within-tools" id="markdown-toc-handling-errors-within-tools">Handling Errors Within Tools</a></li> <li><a href="index.html#automatic-retries" id="markdown-toc-automatic-retries">Automatic Retries</a></li> <li><a href="index.html#debugging" id="markdown-toc-debugging">Debugging</a></li> <li><a href="index.html#best-practices" id="markdown-toc-best-practices">Best Practices</a></li> <li><a href="index.html#next-steps" id="markdown-toc-next-steps">Next Steps</a></li> </ol><hr /> <p>After reading this guide, you will know:</p> <ul> <li>RubyLLM’s error hierarchy.</li> <li>How to rescue specific types of errors.</li> <li>How to access details from the original API response.</li> <li>How errors are handled during streaming.</li> <li>Best practices for handling errors within Tools.</li> <li>RubyLLM’s automatic retry behavior.</li> <li>How to enable debug logging.</li> </ul> <h2 id="rubyllm-error-hierarchy"> <a href="index.html#rubyllm-error-hierarchy" class="anchor-heading" aria-labelledby="rubyllm-error-hierarchy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> RubyLLM Error Hierarchy </h2> <p>All errors raised directly by RubyLLM inherit from <code class="language-plaintext highlighter-rouge">RubyLLM::Error</code>. Specific errors map to common HTTP status codes or library-specific issues:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">Error</span>                    <span class="c1"># Base error class for API/network issues</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">BadRequestError</span>      <span class="c1"># 400: Invalid request parameters</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">UnauthorizedError</span>    <span class="c1"># 401: API key issues</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">PaymentRequiredError</span> <span class="c1"># 402: Billing issues</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">ForbiddenError</span>       <span class="c1"># 403: Permission issues</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">RateLimitError</span>       <span class="c1"># 429: Rate limit exceeded</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">ServerError</span>          <span class="c1"># 500: Provider server error</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">ServiceUnavailableError</span> <span class="c1"># 502/503: Service unavailable</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">OverloadedError</span>      <span class="c1"># 529: Service overloaded (Specific providers)</span>

<span class="c1"># Non-API Errors (inherit from StandardError)</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">ConfigurationError</span>   <span class="c1"># Missing required configuration (e.g., API key)</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">ModelNotFoundError</span>   <span class="c1"># Requested model ID not found in registry</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">InvalidRoleError</span>     <span class="c1"># Invalid role symbol used for a message</span>
</code></pre></div></div> <h2 id="basic-error-handling"> <a href="index.html#basic-error-handling" class="anchor-heading" aria-labelledby="basic-error-handling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Error Handling </h2> <p>The fundamental way to handle errors is using Ruby’s <code class="language-plaintext highlighter-rouge">begin</code>/<code class="language-plaintext highlighter-rouge">rescue</code> block. Catching the base <code class="language-plaintext highlighter-rouge">RubyLLM::Error</code> will handle most API-related issues.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">begin</span>
  <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span> <span class="s2">"Translate 'hello' to French."</span>
  <span class="nb">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">content</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="c1"># Generic handling for API errors</span>
  <span class="nb">puts</span> <span class="s2">"An API error occurred: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span>
  <span class="c1"># Log the error for debugging</span>
  <span class="c1"># logger.error "RubyLLM API Error: #{e.class} - #{e.message}"</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">ConfigurationError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="c1"># Handle missing configuration</span>
  <span class="nb">puts</span> <span class="s2">"Configuration missing: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span>
  <span class="c1"># Abort or prompt for configuration</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="handling-specific-errors"> <a href="index.html#handling-specific-errors" class="anchor-heading" aria-labelledby="handling-specific-errors"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling Specific Errors </h2> <p>For more granular control, rescue specific error classes. This allows you to implement different recovery strategies based on the error type.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">begin</span>
  <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span> <span class="s2">"Generate a complex report."</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">UnauthorizedError</span>
  <span class="nb">puts</span> <span class="s2">"Authentication failed. Please check your API key configuration."</span>
  <span class="c1"># Maybe exit or redirect to config settings</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">PaymentRequiredError</span>
  <span class="nb">puts</span> <span class="s2">"Payment required. Please check your provider account balance or plan."</span>
  <span class="c1"># Notify admin or user</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">RateLimitError</span>
  <span class="nb">puts</span> <span class="s2">"Rate limit hit. Please wait a moment before trying again."</span>
  <span class="c1"># Implement backoff/retry logic (though RubyLLM has some built-in retries)</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">ServiceUnavailableError</span>
  <span class="nb">puts</span> <span class="s2">"The AI service is temporarily unavailable. Please try again later."</span>
  <span class="c1"># Maybe offer a fallback or notify user</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">BadRequestError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="s2">"Invalid request sent to the API: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span>
  <span class="c1"># Check the data being sent</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">ModelNotFoundError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="s2">"Error: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">. Check available models with RubyLLM.models.all"</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="c1"># Catch any other API errors</span>
  <span class="nb">puts</span> <span class="s2">"An unexpected API error occurred: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="accessing-api-response-details"> <a href="index.html#accessing-api-response-details" class="anchor-heading" aria-labelledby="accessing-api-response-details"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Accessing API Response Details </h2> <p>Instances of <code class="language-plaintext highlighter-rouge">RubyLLM::Error</code> (and its subclasses related to API responses) hold the original <code class="language-plaintext highlighter-rouge">Faraday::Response</code> object in the <code class="language-plaintext highlighter-rouge">response</code> attribute. This can be useful for debugging or extracting provider-specific error codes.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">begin</span>
  <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'gpt-4.1-nano'</span><span class="p">)</span> <span class="c1"># Assume this requires a specific org sometimes</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span> <span class="s2">"Some specific query"</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">ForbiddenError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="s2">"Access forbidden: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span>
  <span class="c1"># Inspect the raw response body for provider-specific details</span>
  <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">response</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">body</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s1">'invalid_organization'</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Hint: Check if your API key is enabled for the correct OpenAI organization."</span>
  <span class="k">end</span>
  <span class="nb">puts</span> <span class="s2">"Status Code: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">response</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">status</span><span class="si">}</span><span class="s2">"</span>
  <span class="c1"># puts "Full Response Body: #{e.response&amp;.body}" # For deep debugging</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="error-handling-during-streaming"> <a href="index.html#error-handling-during-streaming" class="anchor-heading" aria-labelledby="error-handling-during-streaming"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Error Handling During Streaming </h2> <p>When using streaming with a block, errors can occur <em>during</em> the stream after some chunks have already been processed. The <code class="language-plaintext highlighter-rouge">ask</code> method will raise the error <em>after</em> the block execution finishes or is interrupted by the error.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">begin</span>
  <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span>
  <span class="n">accumulated_content</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span> <span class="s2">"Generate a very long story..."</span> <span class="k">do</span> <span class="o">|</span><span class="n">chunk</span><span class="o">|</span>
    <span class="nb">print</span> <span class="n">chunk</span><span class="p">.</span><span class="nf">content</span>
    <span class="n">accumulated_content</span> <span class="o">&lt;&lt;</span> <span class="n">chunk</span><span class="p">.</span><span class="nf">content</span>
    <span class="c1"># Simulate an error occurring mid-stream (e.g., network drop)</span>
    <span class="c1"># In a real scenario, the error would be raised by the underlying HTTP request</span>
  <span class="k">end</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Stream completed successfully."</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">RateLimitError</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Stream interrupted by rate limit. Partial content received:"</span>
  <span class="nb">puts</span> <span class="n">accumulated_content</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Stream failed: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">. Partial content received:"</span>
  <span class="nb">puts</span> <span class="n">accumulated_content</span>
<span class="k">end</span>
</code></pre></div></div> <p>Your block will execute for chunks received <em>before</em> the error. The final return value of <code class="language-plaintext highlighter-rouge">ask</code> when an error occurs during streaming might be unpredictable (often <code class="language-plaintext highlighter-rouge">nil</code>), so rely on the rescued exception for error handling.</p> <h2 id="handling-errors-within-tools"> <a href="index.html#handling-errors-within-tools" class="anchor-heading" aria-labelledby="handling-errors-within-tools"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling Errors Within Tools </h2> <p>When building <a href="../tools/index.html">Tools</a>, you need to decide how errors within the tool’s <code class="language-plaintext highlighter-rouge">execute</code> method should be handled:</p> <ol> <li> <p><strong>Return Error to LLM:</strong> If the error is something the LLM might be able to recover from (e.g., invalid parameters provided by the LLM, temporary lookup failure), return a Hash containing an <code class="language-plaintext highlighter-rouge">:error</code> key. The LLM will see this error message as the tool’s output and may try again or use a different approach.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Weather</span> <span class="o">&lt;</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Tool</span>
  <span class="c1"># ... params ...</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">location</span><span class="p">:)</span>
    <span class="k">if</span> <span class="n">location</span><span class="p">.</span><span class="nf">blank?</span>
      <span class="k">return</span> <span class="p">{</span> <span class="ss">error: </span><span class="s2">"Location cannot be blank. Please provide a city name."</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="c1"># ... perform API call ...</span>
  <span class="k">rescue</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">TimeoutError</span>
    <span class="p">{</span> <span class="ss">error: </span><span class="s2">"Weather API timed out. Please try again later."</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> </div> </li> <li> <p><strong>Raise Error for Application:</strong> If the error indicates a problem with the tool itself or the application’s state (e.g., database connection lost, configuration error, unrecoverable external API failure), <code class="language-plaintext highlighter-rouge">raise</code> an exception as normal. This will halt the RubyLLM interaction and bubble up to your application’s main error handling (<code class="language-plaintext highlighter-rouge">begin/rescue</code>).</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DatabaseQueryTool</span> <span class="o">&lt;</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Tool</span>
  <span class="c1"># ... params ...</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">query</span><span class="p">:)</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">find_by_sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="c1"># Example query</span>
  <span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">ConnectionNotEstablished</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="c1"># This is likely an application-level problem, not something the LLM can fix.</span>
    <span class="k">raise</span> <span class="n">e</span> <span class="c1"># Let the application's error handling take over.</span>
  <span class="k">rescue</span> <span class="no">StandardError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="c1"># Maybe return less critical errors to the LLM</span>
    <span class="p">{</span> <span class="ss">error: </span><span class="s2">"Database query failed: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> </div> </li> </ol> <p>Distinguishing between these helps the LLM work effectively with recoverable issues while ensuring critical application failures are handled appropriately.</p> <h2 id="automatic-retries"> <a href="index.html#automatic-retries" class="anchor-heading" aria-labelledby="automatic-retries"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Automatic Retries </h2> <p>RubyLLM automatically retries requests that fail due to transient network or server issues using Faraday’s retry middleware.</p> <p>Retries are attempted for:</p> <ul> <li>Network timeouts (<code class="language-plaintext highlighter-rouge">Timeout::Error</code>, <code class="language-plaintext highlighter-rouge">Faraday::TimeoutError</code>, <code class="language-plaintext highlighter-rouge">Errno::ETIMEDOUT</code>)</li> <li>Connection failures (<code class="language-plaintext highlighter-rouge">Faraday::ConnectionFailed</code>)</li> <li>Rate limit errors (<code class="language-plaintext highlighter-rouge">RubyLLM::RateLimitError</code> / HTTP 429)</li> <li>Server-side errors (<code class="language-plaintext highlighter-rouge">RubyLLM::ServerError</code>, <code class="language-plaintext highlighter-rouge">RubyLLM::ServiceUnavailableError</code>, <code class="language-plaintext highlighter-rouge">RubyLLM::OverloadedError</code> / HTTP 500, 502, 503, 504, 529)</li> </ul> <p>You can configure retry behavior via <code class="language-plaintext highlighter-rouge">RubyLLM.configure</code>:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">max_retries</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Default: 3</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">retry_interval</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Default: 0.1</span>
  <span class="c1"># config.retry_backoff_factor = 2 # Default: 2</span>
  <span class="c1"># config.retry_interval_randomness = 0.5 # Default: 0.5</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="debugging"> <a href="index.html#debugging" class="anchor-heading" aria-labelledby="debugging"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debugging </h2> <p>If you encounter unexpected errors or behavior, enable debug logging by setting the <code class="language-plaintext highlighter-rouge">RUBYLLM_DEBUG</code> environment variable:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">RUBYLLM_DEBUG</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># Now run your Ruby script or Rails server</span>
</code></pre></div></div> <p>This will cause RubyLLM to log detailed information about API requests and responses, including headers and bodies (with sensitive data like API keys filtered), which can be invaluable for troubleshooting.</p> <h2 id="best-practices"> <a href="index.html#best-practices" class="anchor-heading" aria-labelledby="best-practices"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Best Practices </h2> <ul> <li><strong>Be Specific:</strong> Rescue specific error classes whenever possible for tailored recovery logic.</li> <li><strong>Log Errors:</strong> Always log errors, including relevant context (model used, input data if safe) for debugging. Consider using the <code class="language-plaintext highlighter-rouge">response</code> attribute on <code class="language-plaintext highlighter-rouge">RubyLLM::Error</code> for more details.</li> <li><strong>User Feedback:</strong> Provide clear, user-friendly feedback when an AI operation fails. Avoid exposing raw API error messages directly.</li> <li><strong>Fallbacks:</strong> Consider fallback mechanisms (e.g., trying a different model, using cached data, providing a default response) if the AI service is critical to your application’s function.</li> <li><strong>Monitor:</strong> Track the frequency of different error types in production to identify recurring issues with providers or your implementation.</li> </ul> <h2 id="next-steps"> <a href="index.html#next-steps" class="anchor-heading" aria-labelledby="next-steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Next Steps </h2> <ul> <li><a href="../tools/index.html">Using Tools</a></li> <li><a href="../streaming/index.html">Streaming Responses</a></li> <li><a href="../rails/index.html">Rails Integration</a></li> </ul> </main> <hr> <footer> Brought to you by <a href="https://paolino.me">Carmine Paolino</a>, maker of <a href="https://chatwithwork.com"><img src="https://chatwithwork.com/logotype.svg" alt="Chat with Work" class="chatwithwork-logo" style="height: 1.8em; vertical-align: middle; margin: 0 0.25em;"></a> <em style="font-size: 0.85em; opacity: 0.8;">— Claude Code for your documents</em> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
