<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="../assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="../assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul:nth-of-type(5) > li:not(:nth-child(1)) > a, .site-nav > ul:nth-of-type(5) > li > ul > li a { background-image: none; } .site-nav > ul:not(:nth-of-type(5)) a, .site-nav li.external a { background-image: none; } .site-nav > ul:nth-of-type(5) > li:nth-child(1) > a { font-weight: 600; text-decoration: none; } .site-nav > ul.nav-category-list > li > button svg, .site-nav > ul:nth-of-type(5) > li:nth-child(1) > button svg { transform: rotate(-90deg); } .site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list, .site-nav > ul:nth-of-type(5) > li.nav-list-item:nth-child(1) > ul.nav-list { display: block; } </style> <script src="../assets/js/vendor/lunr.min.js"></script> <script src="../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="../assets/images/logo.svg" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Rails Integration | RubyLLM</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Rails Integration" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Rails + AI made simple. Persist chats with ActiveRecord. Stream with Hotwire. Deploy with confidence." /> <meta property="og:description" content="Rails + AI made simple. Persist chats with ActiveRecord. Stream with Hotwire. Deploy with confidence." /> <link rel="canonical" href="index.html" /> <meta property="og:url" content="https://rubyllm.com/rails/" /> <meta property="og:site_name" content="RubyLLM" /> <meta property="og:image" content="https://rubyllm.com/assets/images/og/advanced/rails.png" /> <meta property="og:image:height" content="600" /> <meta property="og:image:width" content="1200" /> <meta property="og:image:alt" content="Rails Integration" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2025-10-22T09:47:33+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://rubyllm.com/assets/images/og/advanced/rails.png" /> <meta name="twitter:image:alt" content="Rails Integration" /> <meta property="twitter:title" content="Rails Integration" /> <meta name="twitter:site" content="@paolino" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-22T09:47:33+00:00","datePublished":"2025-10-22T09:47:33+00:00","description":"Rails + AI made simple. Persist chats with ActiveRecord. Stream with Hotwire. Deploy with confidence.","headline":"Rails Integration","image":{"width":1200,"height":600,"alt":"Rails Integration","url":"https://rubyllm.com/assets/images/og/advanced/rails.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rubyllm.com/rails/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://rubyllm.com/assets/images/logotype.svg"}},"url":"https://rubyllm.com/rails/"}</script> <!-- End Jekyll SEO tag --> <!-- Auto Dark Mode - Must run immediately to prevent flash --> <script src="../assets/js/auto-dark-mode.js"></script> <link rel="icon" type="image/png" href="../assets/images/favicon/favicon-96x96.png" sizes="96x96" /> <link rel="icon" type="image/svg+xml" href="../assets/images/logo.svg" /> <link rel="shortcut icon" href="../assets/images/favicon/favicon.ico" /> <link rel="apple-touch-icon" sizes="180x180" href="../assets/images/favicon/apple-touch-icon.png" /> <meta name="apple-mobile-web-app-title" content="RubyLLM" /> <link rel="manifest" href="../assets/images/favicon/site.webmanifest" /> <!-- Override Twitter card type to use large image --> <meta name="twitter:card" content="summary_large_image"> <script defer data-domain="rubyllm.com" src="https://stats.paolino.me/js/script.outbound-links.js"></script> </head> <body> <a class="skip-to-main" href="index.html#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="../index.html" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="RubyLLM"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="../index.html" class="nav-list-link">Home</a></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/crmne/ruby_llm" class="nav-list-link external" > GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://github.com/crmne/ruby_llm/releases" class="nav-list-link external" > Changelog <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://paolino.me" class="nav-list-link external" > Blog <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> <div class="nav-category">Getting Started</div> <ul class="nav-list"><li class="nav-list-item"><a href="../getting-started/index.html" class="nav-list-link">Getting Started</a></li><li class="nav-list-item"><a href="../overview/index.html" class="nav-list-link">Overview</a></li><li class="nav-list-item"><a href="../configuration/index.html" class="nav-list-link">Configuration</a></li></ul> <div class="nav-category">Core Features</div> <ul class="nav-list"><li class="nav-list-item"><a href="../chat/index.html" class="nav-list-link">Chat</a></li><li class="nav-list-item"><a href="../tools/index.html" class="nav-list-link">Tools</a></li><li class="nav-list-item"><a href="../streaming/index.html" class="nav-list-link">Stream Responses</a></li><li class="nav-list-item"><a href="../embeddings/index.html" class="nav-list-link">Embeddings</a></li><li class="nav-list-item"><a href="../image-generation/index.html" class="nav-list-link">Image Generation</a></li><li class="nav-list-item"><a href="../audio-transcription/index.html" class="nav-list-link">Audio Transcription</a></li><li class="nav-list-item"><a href="../moderation/index.html" class="nav-list-link">Moderation</a></li></ul> <div class="nav-category">Advanced</div> <ul class="nav-list"><li class="nav-list-item"><a href="index.html" class="nav-list-link">Rails Integration</a></li><li class="nav-list-item"><a href="../async/index.html" class="nav-list-link">Scale with Async</a></li><li class="nav-list-item"><a href="../error-handling/index.html" class="nav-list-link">Error Handling</a></li><li class="nav-list-item"><a href="../models/index.html" class="nav-list-link">Model Registry</a></li><li class="nav-list-item"><a href="../agentic-workflows/index.html" class="nav-list-link">Agentic Workflows</a></li><li class="nav-list-item"><a href="../upgrading/index.html" class="nav-list-link">Upgrading</a></li></ul> <div class="nav-category">Reference</div> <ul class="nav-list"><li class="nav-list-item"><a href="../available-models/index.html" class="nav-list-link">Available Models</a></li><li class="nav-list-item"><a href="../ecosystem/index.html" class="nav-list-link">RubyLLM Ecosystem</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search RubyLLM" aria-label="Search RubyLLM" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 class="no_toc" id="rails-integration"> <a href="index.html#rails-integration" class="anchor-heading" aria-labelledby="rails-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Rails Integration </h1> <p class="fs-6 fw-300">Rails + AI made simple. Persist chats with ActiveRecord. Stream with Hotwire. Deploy with confidence.</p> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="index.html#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="index.html#understanding-the-persistence-flow" id="markdown-toc-understanding-the-persistence-flow">Understanding the Persistence Flow</a> <ol> <li><a href="index.html#how-it-works" id="markdown-toc-how-it-works">How It Works</a></li> <li><a href="index.html#why-this-design" id="markdown-toc-why-this-design">Why This Design?</a></li> <li><a href="index.html#content-validation-implications" id="markdown-toc-content-validation-implications">Content Validation Implications</a></li> </ol> </li> <li><a href="index.html#setting-up-your-rails-application" id="markdown-toc-setting-up-your-rails-application">Setting Up Your Rails Application</a> <ol> <li><a href="index.html#quick-setup-with-generator" id="markdown-toc-quick-setup-with-generator">Quick Setup with Generator</a></li> <li><a href="index.html#adding-a-chat-ui" id="markdown-toc-adding-a-chat-ui">Adding a Chat UI</a> <ol> <li><a href="index.html#generator-options" id="markdown-toc-generator-options">Generator Options</a></li> </ol> </li> <li><a href="index.html#setting-up-activestorage" id="markdown-toc-setting-up-activestorage">Setting Up ActiveStorage</a></li> <li><a href="index.html#working-with-raw-provider-payloads-anthropic-prompt-caching" id="markdown-toc-working-with-raw-provider-payloads-anthropic-prompt-caching">Working with Raw Provider Payloads, Anthropic Prompt Caching</a></li> <li><a href="index.html#configuring-rubyllm" id="markdown-toc-configuring-rubyllm">Configuring RubyLLM</a></li> <li><a href="index.html#setting-up-models-with-acts_as-helpers" id="markdown-toc-setting-up-models-with-acts_as-helpers">Setting Up Models with <code class="language-plaintext highlighter-rouge">acts_as</code> Helpers</a> <ol> <li><a href="index.html#with-model-registry-default-for-new-apps" id="markdown-toc-with-model-registry-default-for-new-apps">With Model Registry (Default for new apps)</a></li> <li><a href="index.html#legacy-mode-without-model-registry" id="markdown-toc-legacy-mode-without-model-registry">Legacy Mode (Without Model Registry)</a></li> </ol> </li> <li><a href="index.html#provider-overrides" id="markdown-toc-provider-overrides">Provider Overrides</a></li> <li><a href="index.html#custom-contexts-and-dynamic-models" id="markdown-toc-custom-contexts-and-dynamic-models">Custom Contexts and Dynamic Models</a> <ol> <li><a href="index.html#using-custom-contexts" id="markdown-toc-using-custom-contexts">Using Custom Contexts</a></li> <li><a href="index.html#dynamic-model-creation" id="markdown-toc-dynamic-model-creation">Dynamic Model Creation</a></li> </ol> </li> </ol> </li> <li><a href="index.html#working-with-chats" id="markdown-toc-working-with-chats">Working with Chats</a> <ol> <li><a href="index.html#basic-chat-operations" id="markdown-toc-basic-chat-operations">Basic Chat Operations</a></li> <li><a href="index.html#database-model-registry" id="markdown-toc-database-model-registry">Database Model Registry</a></li> <li><a href="index.html#system-instructions" id="markdown-toc-system-instructions">System Instructions</a></li> <li><a href="index.html#using-tools" id="markdown-toc-using-tools">Using Tools</a></li> <li><a href="index.html#file-attachments" id="markdown-toc-file-attachments">File Attachments</a></li> <li><a href="index.html#structured-output" id="markdown-toc-structured-output">Structured Output</a></li> </ol> </li> <li><a href="index.html#advanced-topics" id="markdown-toc-advanced-topics">Advanced Topics</a> <ol> <li><a href="index.html#handling-edge-cases" id="markdown-toc-handling-edge-cases">Handling Edge Cases</a> <ol> <li><a href="index.html#automatic-cleanup" id="markdown-toc-automatic-cleanup">Automatic Cleanup</a></li> <li><a href="index.html#provider-content-restrictions" id="markdown-toc-provider-content-restrictions">Provider Content Restrictions</a></li> </ol> </li> <li><a href="index.html#customizing-the-persistence-flow" id="markdown-toc-customizing-the-persistence-flow">Customizing the Persistence Flow</a></li> </ol> </li> <li><a href="index.html#streaming-responses-with-hotwireturbo" id="markdown-toc-streaming-responses-with-hotwireturbo">Streaming Responses with Hotwire/Turbo</a> <ol> <li><a href="index.html#instant-user-messages" id="markdown-toc-instant-user-messages">Instant User Messages</a></li> <li><a href="index.html#full-streaming-implementation" id="markdown-toc-full-streaming-implementation">Full Streaming Implementation</a></li> <li><a href="index.html#message-ordering-issues" id="markdown-toc-message-ordering-issues">Message Ordering Issues</a> <ol> <li><a href="index.html#solution-1-client-side-reordering-recommended" id="markdown-toc-solution-1-client-side-reordering-recommended">Solution 1: Client-Side Reordering (Recommended)</a></li> <li><a href="index.html#solution-2-server-side-ordering" id="markdown-toc-solution-2-server-side-ordering">Solution 2: Server-Side Ordering</a></li> <li><a href="index.html#why-this-happens" id="markdown-toc-why-this-happens">Why This Happens</a></li> </ol> </li> </ol> </li> <li><a href="index.html#customizing-models" id="markdown-toc-customizing-models">Customizing Models</a> <ol> <li><a href="index.html#using-custom-model-names" id="markdown-toc-using-custom-model-names">Using Custom Model Names</a> <ol> <li><a href="index.html#with-model-registry" id="markdown-toc-with-model-registry">With Model Registry</a></li> <li><a href="index.html#namespaced-models-example" id="markdown-toc-namespaced-models-example">Namespaced Models Example</a></li> <li><a href="index.html#legacy-mode" id="markdown-toc-legacy-mode">Legacy Mode</a></li> </ol> </li> <li><a href="index.html#common-customizations" id="markdown-toc-common-customizations">Common Customizations</a></li> </ol> </li> <li><a href="index.html#next-steps" id="markdown-toc-next-steps">Next Steps</a></li> </ol><hr /> <p>After reading this guide, you will know:</p> <ul> <li>How to set up ActiveRecord models for persisting chats and messages</li> <li>How the RubyLLM persistence flow works with Rails applications</li> <li>How to use <code class="language-plaintext highlighter-rouge">acts_as_chat</code> and <code class="language-plaintext highlighter-rouge">acts_as_message</code> with your models</li> <li>How to persist AI model metadata in your database with <code class="language-plaintext highlighter-rouge">acts_as_model</code></li> <li>How to send file attachments to AI models with ActiveStorage</li> <li>How to store raw provider payloads (Anthropic prompt caching, etc.)</li> <li>How to integrate streaming responses with Hotwire/Turbo Streams</li> <li>How to customize the persistence behavior for validation-focused scenarios</li> </ul> <h2 id="understanding-the-persistence-flow"> <a href="index.html#understanding-the-persistence-flow" class="anchor-heading" aria-labelledby="understanding-the-persistence-flow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Understanding the Persistence Flow </h2> <p>Before diving into setup, it’s important to understand how RubyLLM handles message persistence in Rails. This design influences model validations and real-time UI updates.</p> <h3 id="how-it-works"> <a href="index.html#how-it-works" class="anchor-heading" aria-labelledby="how-it-works"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How It Works </h3> <p>When calling <code class="language-plaintext highlighter-rouge">chat_record.ask("What is the capital of France?")</code>, RubyLLM:</p> <ol> <li><strong>Saves the user message</strong> with the question content</li> <li><strong>Calls the <code class="language-plaintext highlighter-rouge">complete</code> method</strong>, which: <ul> <li>Makes the API call to the AI provider</li> <li>Creates an empty assistant message: <ul> <li><strong>With streaming</strong>: On receiving the first chunk</li> <li><strong>Without streaming</strong>: Before the API call</li> </ul> </li> <li>Processes the response: <ul> <li><strong>Success</strong>: Updates the assistant message with content and metadata</li> <li><strong>Failure</strong>: Automatically destroys the empty assistant message</li> </ul> </li> </ul> </li> </ol> <h3 id="why-this-design"> <a href="index.html#why-this-design" class="anchor-heading" aria-labelledby="why-this-design"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why This Design? </h3> <p>This approach optimizes for real-time experiences:</p> <ol> <li><strong>Streaming optimized</strong>: Creates DOM target on first chunk for immediate UI updates</li> <li><strong>Turbo Streams ready</strong>: Works with <code class="language-plaintext highlighter-rouge">after_create_commit</code> for real-time broadcasting</li> <li><strong>Clean rollback</strong>: Automatic cleanup on failure prevents orphaned records</li> </ol> <h3 id="content-validation-implications"> <a href="index.html#content-validation-implications" class="anchor-heading" aria-labelledby="content-validation-implications"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Content Validation Implications </h3> <blockquote class="warning"> <p><strong>Important:</strong> You cannot use <code class="language-plaintext highlighter-rouge">validates :content, presence: true</code> on your Message model. See <a href="index.html#customizing-the-persistence-flow">Customizing the Persistence Flow</a> for an alternative approach.</p> </blockquote> <h2 id="setting-up-your-rails-application"> <a href="index.html#setting-up-your-rails-application" class="anchor-heading" aria-labelledby="setting-up-your-rails-application"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting Up Your Rails Application </h2> <h3 id="quick-setup-with-generator"> <a href="index.html#quick-setup-with-generator" class="anchor-heading" aria-labelledby="quick-setup-with-generator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Quick Setup with Generator </h3> <p>The easiest way to get started is using the provided Rails generator:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate ruby_llm:install
</code></pre></div></div> <p>The generator:</p> <ul> <li>Creates migrations for Chat, Message, ToolCall, and Model tables</li> <li>Sets up model files with appropriate <code class="language-plaintext highlighter-rouge">acts_as</code> declarations</li> <li>Installs ActiveStorage for file attachments</li> <li>Configures the database model registry</li> <li>Creates an initializer with sensible defaults</li> </ul> <p>After running the generator:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails db:migrate
</code></pre></div></div> <p>Your Rails app is now AI-ready!</p> <h3 id="adding-a-chat-ui"> <a href="index.html#adding-a-chat-ui" class="anchor-heading" aria-labelledby="adding-a-chat-ui"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Adding a Chat UI </h3> <p>Want a ready-to-use chat interface? Run the chat UI generator:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate ruby_llm:chat_ui
</code></pre></div></div> <p>This creates a complete chat interface with:</p> <ul> <li><strong>Controllers</strong>: Handles chat and message creation with background processing</li> <li><strong>Views</strong>: Modern UI with Turbo Streams for real-time updates</li> <li><strong>Jobs</strong>: Background job for processing AI responses without blocking</li> <li><strong>Routes</strong>: RESTful routes for chats and messages</li> </ul> <p>After running the generator, start your server and visit <code class="language-plaintext highlighter-rouge">http://localhost:3000/chats</code> to begin chatting!</p> <p>The UI generator also supports custom model names:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Use your custom model names from the install generator</span>
rails generate ruby_llm:chat_ui chat:Conversation message:ChatMessage model:AIModel
</code></pre></div></div> <h4 id="generator-options"> <a href="index.html#generator-options" class="anchor-heading" aria-labelledby="generator-options"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generator Options </h4> <p>The generator uses Rails-like syntax for custom model names:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Default - creates Chat, Message, ToolCall, Model</span>
rails generate ruby_llm:install

<span class="c"># Custom model names using Rails conventions</span>
rails generate ruby_llm:install chat:Conversation message:ChatMessage
rails generate ruby_llm:install chat:Discussion message:DiscussionMessage tool_call:FunctionCall model:AIModel

<span class="c"># Skip ActiveStorage if you don't need file attachments</span>
rails generate ruby_llm:install <span class="nt">--skip-active-storage</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">name:ClassName</code> syntax follows Rails conventions - specify only what you want to customize.</p> <h3 id="setting-up-activestorage"> <a href="index.html#setting-up-activestorage" class="anchor-heading" aria-labelledby="setting-up-activestorage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting Up ActiveStorage </h3> <p>The generator automatically configures ActiveStorage for file attachments. If you skipped it during generation, add it manually:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails active_storage:install
rails db:migrate
</code></pre></div></div> <p>Then add to your Message model:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/message.rb</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_message</span>
  <span class="n">has_many_attached</span> <span class="ss">:attachments</span>  <span class="c1"># Required for file attachments</span>
<span class="k">end</span>
</code></pre></div></div> <h3 class="d-inline-block" id="working-with-raw-provider-payloads-anthropic-prompt-caching"> <a href="index.html#working-with-raw-provider-payloads-anthropic-prompt-caching" class="anchor-heading" aria-labelledby="working-with-raw-provider-payloads-anthropic-prompt-caching"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Working with Raw Provider Payloads, Anthropic Prompt Caching </h3> <p class="label label-green">v1.9.0+</p> <p>Providers like Anthropic expose advanced features (prompt caching, fine-grained metadata) by embedding rich structures inside each prompt block. Use <code class="language-plaintext highlighter-rouge">RubyLLM::Content::Raw</code> to persist those blocks alongside your conversation history:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw_block</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Content</span><span class="o">::</span><span class="no">Raw</span><span class="p">.</span><span class="nf">new</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">type: </span><span class="s1">'text'</span><span class="p">,</span> <span class="ss">text: </span><span class="s1">'Reusable analysis prompt'</span><span class="p">,</span> <span class="ss">cache_control: </span><span class="p">{</span> <span class="ss">type: </span><span class="s1">'ephemeral'</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">type: </span><span class="s1">'text'</span><span class="p">,</span> <span class="ss">text: </span><span class="s2">"Today's request: </span><span class="si">#{</span><span class="n">summary</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
<span class="p">])</span>

<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'claude-sonnet-4-5'</span><span class="p">)</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="n">raw_block</span><span class="p">)</span>
</code></pre></div></div> <p>The v1.9 schema adds a <code class="language-plaintext highlighter-rouge">content_raw</code> column so raw payloads live alongside the plain-text <code class="language-plaintext highlighter-rouge">content</code> field. When you load messages via <code class="language-plaintext highlighter-rouge">acts_as_message</code>, RubyLLM reconstructs the original <code class="language-plaintext highlighter-rouge">Content::Raw</code> automatically.</p> <blockquote class="note"> <p>Existing apps: run <code class="language-plaintext highlighter-rouge">rails generate ruby_llm:upgrade_to_v1_9</code> to add cached-token tracking and raw content storage columns introduced in v1.9.0. New apps will get the proper columns from the install generator.</p> </blockquote> <h3 id="configuring-rubyllm"> <a href="index.html#configuring-rubyllm" class="anchor-heading" aria-labelledby="configuring-rubyllm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring RubyLLM </h3> <p>Set up your API keys and other configuration in the initializer:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/ruby_llm.rb</span>
<span class="no">RubyLLM</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">openai_api_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'OPENAI_API_KEY'</span><span class="p">]</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">anthropic_api_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'ANTHROPIC_API_KEY'</span><span class="p">]</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">gemini_api_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'GEMINI_API_KEY'</span><span class="p">]</span>

  <span class="c1"># New apps: Use modern API (generator adds this)</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">use_new_acts_as</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># For custom Model class names (defaults to 'Model')</span>
  <span class="c1"># config.model_registry_class = 'AIModel'</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="setting-up-models-with-acts_as-helpers"> <a href="index.html#setting-up-models-with-acts_as-helpers" class="anchor-heading" aria-labelledby="setting-up-models-with-acts_as-helpers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting Up Models with <code class="language-plaintext highlighter-rouge">acts_as</code> Helpers </h3> <blockquote class="warning"> <p><strong>New in v1.7.0:</strong> Rails-like <code class="language-plaintext highlighter-rouge">acts_as</code> API with association names!</p> <ul> <li><strong>New apps</strong>: Generator sets <code class="language-plaintext highlighter-rouge">config.use_new_acts_as = true</code> for modern API</li> <li><strong>Existing apps</strong>: Continue using legacy API (with deprecation warning)</li> <li><strong>Migrate today</strong>: Set <code class="language-plaintext highlighter-rouge">config.use_new_acts_as = true</code> to use the better API</li> <li><strong>Legacy API removed in 2.0</strong>: The new API will become the only option</li> </ul> </blockquote> <p>Add RubyLLM capabilities to your models:</p> <h4 class="d-inline-block" id="with-model-registry-default-for-new-apps"> <a href="index.html#with-model-registry-default-for-new-apps" class="anchor-heading" aria-labelledby="with-model-registry-default-for-new-apps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> With Model Registry (Default for new apps) </h4> <p class="label label-green">Available in v1.7.0+</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/chat.rb</span>
<span class="k">class</span> <span class="nc">Chat</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># New API style - uses association names as primary parameters</span>
  <span class="n">acts_as_chat</span> <span class="c1"># Defaults: messages: :messages, model: :model</span>

  <span class="c1"># Or with custom associations:</span>
  <span class="c1"># acts_as_chat messages: :chat_messages,</span>
  <span class="c1">#              message_class: 'ChatMessage',  # Only needed if class can't be inferred</span>
  <span class="c1">#              model: :ai_model</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="c1"># app/models/message.rb</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># New API style - uses association names</span>
  <span class="n">acts_as_message</span> <span class="c1"># Defaults: chat: :chat, tool_calls: :tool_calls, model: :model</span>

  <span class="c1"># Or with custom associations:</span>
  <span class="c1"># acts_as_message chat: :conversation,</span>
  <span class="c1">#                 chat_class: 'Conversation',  # Only needed if class can't be inferred</span>
  <span class="c1">#                 tool_calls: :function_calls</span>

  <span class="c1"># Note: Do NOT add "validates :content, presence: true"</span>
  <span class="n">validates</span> <span class="ss">:role</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:chat</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="c1"># app/models/tool_call.rb</span>
<span class="k">class</span> <span class="nc">ToolCall</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_tool_call</span> <span class="c1"># Defaults: message: :message, result: :result</span>
<span class="k">end</span>

<span class="c1"># app/models/model.rb</span>
<span class="k">class</span> <span class="nc">Model</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_model</span> <span class="c1"># Defaults: chats: :chats</span>
<span class="k">end</span>
</code></pre></div></div> <h4 class="d-inline-block" id="legacy-mode-without-model-registry"> <a href="index.html#legacy-mode-without-model-registry" class="anchor-heading" aria-labelledby="legacy-mode-without-model-registry"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Legacy Mode (Without Model Registry) </h4> <p class="label label-yellow">Pre-1.7.0 or opt-in</p> <blockquote class="note"> <p>Default behavior for existing apps. Set <code class="language-plaintext highlighter-rouge">config.use_new_acts_as = true</code> to upgrade! Legacy API will be removed in 2.0.</p> </blockquote> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/chat.rb</span>
<span class="k">class</span> <span class="nc">Chat</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># Legacy API style - requires explicit class names</span>
  <span class="n">acts_as_chat</span> <span class="ss">message_class: </span><span class="s1">'Message'</span><span class="p">,</span>
               <span class="ss">tool_call_class: </span><span class="s1">'ToolCall'</span><span class="p">,</span>
               <span class="ss">model_class: </span><span class="s1">'Model'</span>  <span class="c1"># Ignored in legacy mode</span>
<span class="k">end</span>

<span class="c1"># app/models/message.rb</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># Legacy API style - all class names and foreign keys explicit</span>
  <span class="n">acts_as_message</span> <span class="ss">chat_class: </span><span class="s1">'Chat'</span><span class="p">,</span>
                  <span class="ss">chat_foreign_key: </span><span class="s1">'chat_id'</span><span class="p">,</span>
                  <span class="ss">tool_call_class: </span><span class="s1">'ToolCall'</span><span class="p">,</span>
                  <span class="ss">model_class: </span><span class="s1">'Model'</span>  <span class="c1"># Ignored in legacy mode</span>
<span class="k">end</span>

<span class="c1"># app/models/tool_call.rb</span>
<span class="k">class</span> <span class="nc">ToolCall</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_tool_call</span> <span class="ss">message_class: </span><span class="s1">'Message'</span><span class="p">,</span>
                    <span class="ss">message_foreign_key: </span><span class="s1">'message_id'</span>
<span class="k">end</span>

<span class="c1"># Note: No Model class in legacy mode - uses string fields instead</span>
</code></pre></div></div> <h3 class="d-inline-block" id="provider-overrides"> <a href="index.html#provider-overrides" class="anchor-heading" aria-labelledby="provider-overrides"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Provider Overrides </h3> <p class="label label-green">Available in v1.7.0+</p> <p>Route models through different providers dynamically:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Use a model through a different provider</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
  <span class="ss">model: </span><span class="s1">'claude-sonnet-4'</span><span class="p">,</span>
  <span class="ss">provider: </span><span class="s1">'bedrock'</span>  <span class="c1"># Use AWS Bedrock instead of Anthropic</span>
<span class="p">)</span>

<span class="c1"># The model registry handles the routing automatically</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"Hello!"</span><span class="p">)</span>
</code></pre></div></div> <h3 class="d-inline-block" id="custom-contexts-and-dynamic-models"> <a href="index.html#custom-contexts-and-dynamic-models" class="anchor-heading" aria-labelledby="custom-contexts-and-dynamic-models"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom Contexts and Dynamic Models </h3> <p class="label label-green">Available in v1.7.0+</p> <h4 id="using-custom-contexts"> <a href="index.html#using-custom-contexts" class="anchor-heading" aria-labelledby="using-custom-contexts"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Custom Contexts </h4> <p>Use different API keys per chat in multi-tenant applications:</p> <p><strong>With DB-backed model registry (default in v1.7.0+):</strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a custom context</span>
<span class="n">custom_context</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">context</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">openai_api_key</span> <span class="o">=</span> <span class="s1">'sk-customer-specific-key'</span>
<span class="k">end</span>

<span class="c1"># Pass context when creating the chat</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
  <span class="ss">model: </span><span class="s1">'gpt-4.1'</span><span class="p">,</span>
  <span class="ss">context: </span><span class="n">custom_context</span>
<span class="p">)</span>
</code></pre></div></div> <p><strong>Legacy mode (when using <code class="language-plaintext highlighter-rouge">--skip-model-registry</code>):</strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># In legacy mode, you can set context after creation</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'gpt-4'</span><span class="p">)</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">with_context</span><span class="p">(</span><span class="n">custom_context</span><span class="p">)</span>  <span class="c1"># This method only exists in legacy mode</span>
</code></pre></div></div> <blockquote class="warning"> <p><strong>Warning:</strong> Context is not persisted. Set it after reloading chats.</p> </blockquote> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Later, in a different request or after restart</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">context</span> <span class="o">=</span> <span class="n">custom_context</span>  <span class="c1"># Must set this!</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"Continue our conversation"</span><span class="p">)</span>
</code></pre></div></div> <p>For multi-tenant apps, consider using an <code class="language-plaintext highlighter-rouge">after_find</code> callback:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Chat</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_chat</span>
  <span class="n">belongs_to</span> <span class="ss">:tenant</span>

  <span class="n">after_find</span> <span class="ss">:set_tenant_context</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_tenant_context</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">context</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">context</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
      <span class="n">config</span><span class="p">.</span><span class="nf">openai_api_key</span> <span class="o">=</span> <span class="n">tenant</span><span class="p">.</span><span class="nf">openai_api_key</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h4 id="dynamic-model-creation"> <a href="index.html#dynamic-model-creation" class="anchor-heading" aria-labelledby="dynamic-model-creation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dynamic Model Creation </h4> <p>When using models not in the registry (e.g., new OpenRouter models):</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create chat with a dynamic model</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
  <span class="ss">model: </span><span class="s1">'experimental-llm-v2'</span><span class="p">,</span>
  <span class="ss">provider: </span><span class="s1">'openrouter'</span><span class="p">,</span>
  <span class="ss">assume_model_exists: </span><span class="kp">true</span>  <span class="c1"># Creates Model record automatically</span>
<span class="p">)</span>
</code></pre></div></div> <blockquote class="note"> <p><strong>Note:</strong> Like context, <code class="language-plaintext highlighter-rouge">assume_model_exists</code> is not persisted.</p> </blockquote> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># When switching to another dynamic model later</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">assume_model_exists</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">with_model</span><span class="p">(</span><span class="s1">'another-experimental-model'</span><span class="p">,</span> <span class="ss">provider: </span><span class="s1">'openrouter'</span><span class="p">)</span>
</code></pre></div></div> <h2 id="working-with-chats"> <a href="index.html#working-with-chats" class="anchor-heading" aria-labelledby="working-with-chats"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Working with Chats </h2> <h3 id="basic-chat-operations"> <a href="index.html#basic-chat-operations" class="anchor-heading" aria-labelledby="basic-chat-operations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Chat Operations </h3> <p>The <code class="language-plaintext highlighter-rouge">acts_as_chat</code> helper provides all standard chat methods:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a chat</span>
<span class="n">chat_record</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'gpt-4.1-nano'</span><span class="p">,</span> <span class="ss">user: </span><span class="n">current_user</span><span class="p">)</span>

<span class="c1"># Ask a question - the persistence flow runs automatically</span>
<span class="k">begin</span>
  <span class="c1"># This saves the user message, then calls complete() which:</span>
  <span class="c1"># 1. Creates an empty assistant message</span>
  <span class="c1"># 2. Makes the API call</span>
  <span class="c1"># 3. Updates the message on success, or destroys it on failure</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span> <span class="s2">"What is the capital of France?"</span>

  <span class="c1"># Get the persisted message record from the database</span>
  <span class="n">assistant_message_record</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">last</span>
  <span class="nb">puts</span> <span class="n">assistant_message_record</span><span class="p">.</span><span class="nf">content</span> <span class="c1"># =&gt; "The capital of France is Paris."</span>
<span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="s2">"API Call Failed: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span>
  <span class="c1"># The empty assistant message is automatically cleaned up on failure</span>
<span class="k">end</span>

<span class="c1"># Continue the conversation</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span> <span class="s2">"Tell me more about that city"</span>

<span class="c1"># Verify persistence</span>
<span class="nb">puts</span> <span class="s2">"Conversation length: </span><span class="si">#{</span><span class="n">chat_record</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2">"</span> <span class="c1"># =&gt; 4</span>
</code></pre></div></div> <h3 class="d-inline-block" id="database-model-registry"> <a href="index.html#database-model-registry" class="anchor-heading" aria-labelledby="database-model-registry"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Database Model Registry </h3> <p class="label label-green">Available in v1.7.0+</p> <p>When using the Model registry (created by default by the generator), your chats and messages get associations to model records:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># String automatically resolves to Model record</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'gpt-4.1'</span><span class="p">)</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">model</span> <span class="c1"># =&gt; #&lt;Model model_id: "gpt-4o", provider: "openai"&gt;</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">model</span><span class="p">.</span><span class="nf">name</span> <span class="c1"># =&gt; "GPT-4"</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">model</span><span class="p">.</span><span class="nf">context_window</span> <span class="c1"># =&gt; 128000</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">model</span><span class="p">.</span><span class="nf">supports_vision</span> <span class="c1"># =&gt; true</span>

<span class="c1"># Populate/refresh models from models.json</span>
<span class="n">rails</span> <span class="n">ruby_llm</span><span class="ss">:load_models</span>

<span class="c1"># Query based on model attributes</span>
<span class="no">Chat</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:model</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">models: </span><span class="p">{</span> <span class="ss">provider: </span><span class="s1">'anthropic'</span> <span class="p">})</span>
<span class="no">Model</span><span class="p">.</span><span class="nf">left_joins</span><span class="p">(</span><span class="ss">:chats</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="s1">'COUNT(chats.id) DESC'</span><span class="p">)</span>

<span class="c1"># Find models with specific capabilities</span>
<span class="no">Model</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">supports_functions: </span><span class="kp">true</span><span class="p">)</span>
<span class="no">Model</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">supports_vision: </span><span class="kp">true</span><span class="p">)</span>
</code></pre></div></div> <h3 id="system-instructions"> <a href="index.html#system-instructions" class="anchor-heading" aria-labelledby="system-instructions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> System Instructions </h3> <p>System prompts are persisted as messages with the <code class="language-plaintext highlighter-rouge">system</code> role:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chat_record</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'gpt-4.1-nano'</span><span class="p">)</span>

<span class="c1"># This creates and saves a Message record with role: :system</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">with_instructions</span><span class="p">(</span><span class="s2">"You are a Ruby expert."</span><span class="p">)</span>

<span class="c1"># Replace all system messages with a new one</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">with_instructions</span><span class="p">(</span><span class="s2">"You are a concise Ruby expert."</span><span class="p">,</span> <span class="ss">replace: </span><span class="kp">true</span><span class="p">)</span>

<span class="n">system_message</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">role: :system</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">system_message</span><span class="p">.</span><span class="nf">content</span> <span class="c1"># =&gt; "You are a concise Ruby expert."</span>
</code></pre></div></div> <h3 id="using-tools"> <a href="index.html#using-tools" class="anchor-heading" aria-labelledby="using-tools"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Tools </h3> <p>Tools are Ruby classes that the AI can call. While the tool classes themselves aren’t persisted, the tool calls and their results are saved as messages:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define a tool (this is just a Ruby class, not persisted)</span>
<span class="k">class</span> <span class="nc">Weather</span> <span class="o">&lt;</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Tool</span>
  <span class="n">description</span> <span class="s2">"Gets current weather for a location"</span>
  <span class="n">param</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">desc: </span><span class="s2">"City name"</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">city</span><span class="p">:)</span>
    <span class="s2">"The weather in </span><span class="si">#{</span><span class="n">city</span><span class="si">}</span><span class="s2"> is sunny and 22°C."</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Register the tool with your chat</span>
<span class="n">chat_record</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'gpt-4.1-nano'</span><span class="p">)</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">with_tool</span><span class="p">(</span><span class="no">Weather</span><span class="p">)</span>

<span class="c1"># When the AI uses the tool, both the call and result are persisted</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"What's the weather in Paris?"</span><span class="p">)</span>

<span class="c1"># Check persisted messages:</span>
<span class="c1"># 1. User message: "What's the weather in Paris?"</span>
<span class="c1"># 2. Assistant message with tool_calls (the AI's decision to use the tool)</span>
<span class="c1"># 3. Tool result message (the output from Weather#execute)</span>
<span class="nb">puts</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 3</span>

<span class="c1"># The tool call details are stored in the ToolCall table</span>
<span class="n">tool_call</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">tool_calls</span><span class="p">.</span><span class="nf">first</span>
<span class="nb">puts</span> <span class="n">tool_call</span><span class="p">.</span><span class="nf">name</span> <span class="c1"># =&gt; "Weather"</span>
<span class="nb">puts</span> <span class="n">tool_call</span><span class="p">.</span><span class="nf">arguments</span> <span class="c1"># =&gt; {"city" =&gt; "Paris"}</span>
</code></pre></div></div> <h3 id="file-attachments"> <a href="index.html#file-attachments" class="anchor-heading" aria-labelledby="file-attachments"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> File Attachments </h3> <p>Send files to AI models using ActiveStorage:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a chat</span>
<span class="n">chat_record</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'claude-sonnet-4'</span><span class="p">)</span>

<span class="c1"># Send a single file - type automatically detected</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"What's in this file?"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"app/assets/images/diagram.png"</span><span class="p">)</span>

<span class="c1"># Send multiple files of different types - all automatically detected</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"What are in these files?"</span><span class="p">,</span> <span class="ss">with: </span><span class="p">[</span>
  <span class="s2">"app/assets/documents/report.pdf"</span><span class="p">,</span>
  <span class="s2">"app/assets/images/chart.jpg"</span><span class="p">,</span>
  <span class="s2">"app/assets/text/notes.txt"</span><span class="p">,</span>
  <span class="s2">"app/assets/audio/recording.mp3"</span>
<span class="p">])</span>

<span class="c1"># Works with file uploads from forms</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"Analyze this file"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">params</span><span class="p">[</span><span class="ss">:uploaded_file</span><span class="p">])</span>

<span class="c1"># Works with existing ActiveStorage attachments</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"What's in this document?"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">profile_document</span><span class="p">)</span>
</code></pre></div></div> <p>File types are automatically detected from extensions or MIME types.</p> <h3 id="structured-output"> <a href="index.html#structured-output" class="anchor-heading" aria-labelledby="structured-output"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Structured Output </h3> <p>Generate and persist structured responses:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define a schema</span>
<span class="k">class</span> <span class="nc">PersonSchema</span> <span class="o">&lt;</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">Schema</span>
  <span class="n">string</span> <span class="ss">:name</span>
  <span class="n">integer</span> <span class="ss">:age</span>
  <span class="n">string</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">false</span>
<span class="k">end</span>

<span class="c1"># Use with your persisted chat</span>
<span class="n">chat_record</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">model: </span><span class="s1">'gpt-4.1-nano'</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">with_schema</span><span class="p">(</span><span class="no">PersonSchema</span><span class="p">).</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"Generate a person from Paris"</span><span class="p">)</span>

<span class="c1"># The structured response is automatically parsed as a Hash</span>
<span class="nb">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">content</span> <span class="c1"># =&gt; {"name" =&gt; "Marie", "age" =&gt; 28, "city" =&gt; "Paris"}</span>

<span class="c1"># But it's stored as JSON in the database</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">last</span>
<span class="nb">puts</span> <span class="n">message</span><span class="p">.</span><span class="nf">content</span> <span class="c1"># =&gt; "{\"name\":\"Marie\",\"age\":28,\"city\":\"Paris\"}"</span>
<span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">content</span><span class="p">)</span> <span class="c1"># =&gt; {"name" =&gt; "Marie", "age" =&gt; 28, "city" =&gt; "Paris"}</span>
</code></pre></div></div> <p>Schemas work in multi-turn conversations:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Start with a schema</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">with_schema</span><span class="p">(</span><span class="no">PersonSchema</span><span class="p">)</span>
<span class="n">person</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"Generate a French person"</span><span class="p">)</span>

<span class="c1"># Remove the schema for analysis</span>
<span class="n">chat_record</span><span class="p">.</span><span class="nf">with_schema</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"What's interesting about this person?"</span><span class="p">)</span>

<span class="c1"># All messages are persisted correctly</span>
<span class="nb">puts</span> <span class="n">chat_record</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 4</span>
</code></pre></div></div> <h2 id="advanced-topics"> <a href="index.html#advanced-topics" class="anchor-heading" aria-labelledby="advanced-topics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Topics </h2> <h3 id="handling-edge-cases"> <a href="index.html#handling-edge-cases" class="anchor-heading" aria-labelledby="handling-edge-cases"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling Edge Cases </h3> <h4 id="automatic-cleanup"> <a href="index.html#automatic-cleanup" class="anchor-heading" aria-labelledby="automatic-cleanup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Automatic Cleanup </h4> <p>RubyLLM automatically cleans up empty assistant messages when API calls fail. This prevents orphaned records that could cause issues with providers that reject empty content.</p> <h4 id="provider-content-restrictions"> <a href="index.html#provider-content-restrictions" class="anchor-heading" aria-labelledby="provider-content-restrictions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Provider Content Restrictions </h4> <p>Some providers (like Gemini) reject conversations with empty message content. RubyLLM’s automatic cleanup ensures this isn’t an issue during normal operation.</p> <h3 id="customizing-the-persistence-flow"> <a href="index.html#customizing-the-persistence-flow" class="anchor-heading" aria-labelledby="customizing-the-persistence-flow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Customizing the Persistence Flow </h3> <p>For applications requiring content validations, override the default persistence methods:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/chat.rb</span>
<span class="k">class</span> <span class="nc">Chat</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_chat</span>

  <span class="c1"># Override the default persistence methods</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">persist_new_message</span>
    <span class="c1"># Create a new message object but don't save it yet</span>
    <span class="vi">@message</span> <span class="o">=</span> <span class="n">messages</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">role: :assistant</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">persist_message_completion</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="n">message</span>

    <span class="c1"># Fill in attributes and save once we have content</span>
    <span class="vi">@message</span><span class="p">.</span><span class="nf">assign_attributes</span><span class="p">(</span>
      <span class="ss">content: </span><span class="n">message</span><span class="p">.</span><span class="nf">content</span><span class="p">,</span>
      <span class="ss">model: </span><span class="no">Model</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">model_id: </span><span class="n">message</span><span class="p">.</span><span class="nf">model_id</span><span class="p">),</span>
      <span class="ss">input_tokens: </span><span class="n">message</span><span class="p">.</span><span class="nf">input_tokens</span><span class="p">,</span>
      <span class="ss">output_tokens: </span><span class="n">message</span><span class="p">.</span><span class="nf">output_tokens</span>
    <span class="p">)</span>

    <span class="vi">@message</span><span class="p">.</span><span class="nf">save!</span>

    <span class="c1"># Handle tool calls if present</span>
    <span class="n">persist_tool_calls</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">tool_calls</span><span class="p">)</span> <span class="k">if</span> <span class="n">message</span><span class="p">.</span><span class="nf">tool_calls</span><span class="p">.</span><span class="nf">present?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">persist_tool_calls</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">)</span>
    <span class="n">tool_calls</span><span class="p">.</span><span class="nf">each_value</span> <span class="k">do</span> <span class="o">|</span><span class="n">tool_call</span><span class="o">|</span>
      <span class="n">attributes</span> <span class="o">=</span> <span class="n">tool_call</span><span class="p">.</span><span class="nf">to_h</span>
      <span class="n">attributes</span><span class="p">[</span><span class="ss">:tool_call_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
      <span class="vi">@message</span><span class="p">.</span><span class="nf">tool_calls</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="o">**</span><span class="n">attributes</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/models/message.rb</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_message</span>

  <span class="c1"># Now you can safely add this validation</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div> <p>This approach trades streaming UI updates for content validation support:</p> <ul> <li>✅ Content validations work</li> <li>✅ No empty messages in database</li> <li>❌ No DOM target for streaming before API response</li> </ul> <h2 id="streaming-responses-with-hotwireturbo"> <a href="index.html#streaming-responses-with-hotwireturbo" class="anchor-heading" aria-labelledby="streaming-responses-with-hotwireturbo"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Streaming Responses with Hotwire/Turbo </h2> <p>The default persistence flow is designed to work seamlessly with streaming and Turbo Streams for real-time UI updates.</p> <h3 id="instant-user-messages"> <a href="index.html#instant-user-messages" class="anchor-heading" aria-labelledby="instant-user-messages"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Instant User Messages </h3> <p>Show user messages immediately for better UX:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/messages_controller.rb</span>
<span class="k">class</span> <span class="nc">MessagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:chat_id</span><span class="p">])</span>

    <span class="c1"># Create and persist the user message immediately</span>
    <span class="vi">@chat</span><span class="p">.</span><span class="nf">create_user_message</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:content</span><span class="p">])</span>

    <span class="c1"># Process AI response in background</span>
    <span class="no">ChatStreamJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="vi">@chat</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>

    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">turbo_stream</span> <span class="p">{</span> <span class="n">head</span> <span class="ss">:ok</span> <span class="p">}</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@chat</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">create_user_message</code> method provides instant feedback while processing continues in the background.</p> <h3 id="full-streaming-implementation"> <a href="index.html#full-streaming-implementation" class="anchor-heading" aria-labelledby="full-streaming-implementation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Full Streaming Implementation </h3> <p>Complete example with background jobs and Turbo Streams:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/chat.rb</span>
<span class="k">class</span> <span class="nc">Chat</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_chat</span>
  <span class="n">broadcasts_to</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">chat</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="n">chat</span><span class="p">,</span> <span class="s2">"messages"</span><span class="p">]</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># app/models/message.rb</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_message</span>
  <span class="n">broadcasts_to</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="n">message</span><span class="p">.</span><span class="nf">chat</span><span class="p">,</span> <span class="s2">"messages"</span><span class="p">]</span> <span class="p">}</span>

  <span class="c1"># Helper to broadcast chunks during streaming</span>
  <span class="k">def</span> <span class="nf">broadcast_append_chunk</span><span class="p">(</span><span class="n">chunk_content</span><span class="p">)</span>
    <span class="n">broadcast_append_to</span> <span class="p">[</span> <span class="n">chat</span><span class="p">,</span> <span class="s2">"messages"</span> <span class="p">],</span> <span class="c1"># Target the stream</span>
      <span class="ss">target: </span><span class="n">dom_id</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">),</span> <span class="c1"># Target the content div inside the message frame</span>
      <span class="ss">html: </span><span class="n">chunk_content</span> <span class="c1"># Append the raw chunk</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/jobs/chat_stream_job.rb</span>
<span class="k">class</span> <span class="nc">ChatStreamJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:default</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
    <span class="n">chat</span> <span class="o">=</span> <span class="no">Chat</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>

    <span class="c1"># Process the latest user message</span>
    <span class="n">chat</span><span class="p">.</span><span class="nf">complete</span> <span class="k">do</span> <span class="o">|</span><span class="n">chunk</span><span class="o">|</span>
      <span class="c1"># Get the assistant message record (created before streaming starts)</span>
      <span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">last</span>
      <span class="k">if</span> <span class="n">chunk</span><span class="p">.</span><span class="nf">content</span> <span class="o">&amp;&amp;</span> <span class="n">assistant_message</span>
        <span class="c1"># Append the chunk content to the message's target div</span>
        <span class="n">assistant_message</span><span class="p">.</span><span class="nf">broadcast_append_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">.</span><span class="nf">content</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1"># Final assistant message is now fully persisted</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;%# app/views/chats/show.html.erb %&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">turbo_stream_from</span> <span class="p">[</span><span class="vi">@chat</span><span class="p">,</span> <span class="s2">"messages"</span><span class="p">]</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Chat <span class="cp">&lt;%=</span> <span class="vi">@chat</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@chat</span><span class="p">.</span><span class="nf">messages</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="c">&lt;!-- Your form to submit new messages --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">form_with</span><span class="p">(</span><span class="ss">url: </span><span class="n">chat_messages_path</span><span class="p">(</span><span class="vi">@chat</span><span class="p">),</span> <span class="ss">method: :post</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_area</span> <span class="ss">:content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Send"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="c">&lt;%# app/views/messages/_message.html.erb %&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="n">message</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"message </span><span class="cp">&lt;%=</span> <span class="n">message</span><span class="p">.</span><span class="nf">role</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong&gt;</span><span class="cp">&lt;%=</span> <span class="n">message</span><span class="p">.</span><span class="nf">role</span><span class="p">.</span><span class="nf">capitalize</span> <span class="cp">%&gt;</span>:<span class="nt">&lt;/strong&gt;</span>
    <span class="c">&lt;%# Target div for streaming content %&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dom_id</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">style=</span><span class="s">"display: inline;"</span><span class="nt">&gt;</span>
      <span class="c">&lt;%# Render initial content if not streaming, otherwise job appends here %&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">message</span><span class="p">.</span><span class="nf">content</span><span class="p">.</span><span class="nf">present?</span> <span class="p">?</span> <span class="n">simple_format</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">content</span><span class="p">)</span> <span class="p">:</span> <span class="s1">'&lt;span class="thinking"&gt;...&lt;/span&gt;'</span><span class="p">.</span><span class="nf">html_safe</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div> <p>This implementation provides:</p> <ul> <li>Real-time UI updates during generation</li> <li>Background processing to prevent timeouts</li> <li>Automatic persistence of all messages and tool calls</li> </ul> <h3 id="message-ordering-issues"> <a href="index.html#message-ordering-issues" class="anchor-heading" aria-labelledby="message-ordering-issues"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Message Ordering Issues </h3> <p>Action Cable processes messages concurrently, which can cause out-of-order delivery:</p> <h4 id="solution-1-client-side-reordering-recommended"> <a href="index.html#solution-1-client-side-reordering-recommended" class="anchor-heading" aria-labelledby="solution-1-client-side-reordering-recommended"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Solution 1: Client-Side Reordering (Recommended) </h4> <p>Use Stimulus to maintain chronological order:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/javascript/controllers/message_ordering_controller.js</span>
<span class="c1">// Note: This is an example implementation. Test thoroughly before production use.</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Controller</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@hotwired/stimulus</span><span class="dl">"</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="nc">extends</span> <span class="nx">Controller</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="nx">targets</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">]</span>

  <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nf">reorderMessages</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nf">observeNewMessages</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="nf">observeNewMessages</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Watch for new messages being added to the DOM</span>
    <span class="kd">const</span> <span class="nx">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutationObserver</span><span class="p">((</span><span class="nx">mutations</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">shouldReorder</span> <span class="o">=</span> <span class="kc">false</span>

      <span class="nx">mutations</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">mutation</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">mutation</span><span class="p">.</span><span class="nx">addedNodes</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">if </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nf">matches</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-message-ordering-target="message"]</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">shouldReorder</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="p">}</span>
        <span class="p">})</span>
      <span class="p">})</span>

      <span class="k">if </span><span class="p">(</span><span class="nx">shouldReorder</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Small delay to ensure all attributes are set</span>
        <span class="nf">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nf">reorderMessages</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">observer</span><span class="p">.</span><span class="nf">observe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="p">{</span> <span class="na">childList</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">subtree</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">observer</span> <span class="o">=</span> <span class="nx">observer</span>
  <span class="p">}</span>

  <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">observer</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">observer</span><span class="p">.</span><span class="nf">disconnect</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nf">reorderMessages</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">messageTargets</span><span class="p">)</span>

    <span class="c1">// Sort by timestamp (created_at)</span>
    <span class="nx">messages</span><span class="p">.</span><span class="nf">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">timeA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">).</span><span class="nf">getTime</span><span class="p">()</span>
      <span class="kd">const</span> <span class="nx">timeB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">).</span><span class="nf">getTime</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">timeA</span> <span class="o">-</span> <span class="nx">timeB</span>
    <span class="p">})</span>

    <span class="c1">// Reorder in DOM</span>
    <span class="nx">messages</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Update your views to use the controller:</p> <div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;%# app/views/chats/show.html.erb %&gt;</span>
<span class="c">&lt;!-- Add the Stimulus controller to the messages container --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"messages"</span> <span class="na">data-controller=</span><span class="s">"message-ordering"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@chat</span><span class="p">.</span><span class="nf">messages</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="c">&lt;%# app/views/messages/_message.html.erb %&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="n">message</span><span class="p">,</span>
    <span class="ss">data: </span><span class="p">{</span>
      <span class="ss">message_ordering_target: </span><span class="s2">"message"</span><span class="p">,</span>
      <span class="ss">created_at: </span><span class="n">message</span><span class="p">.</span><span class="nf">created_at</span><span class="p">.</span><span class="nf">iso8601</span>
    <span class="p">}</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;!-- message content --&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div> <h4 id="solution-2-server-side-ordering"> <a href="index.html#solution-2-server-side-ordering" class="anchor-heading" aria-labelledby="solution-2-server-side-ordering"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Solution 2: Server-Side Ordering </h4> <p><a href="https://anycable.io">AnyCable</a> provides order guarantees at the server level through “sticky concurrency” - ensuring messages from the same stream are processed by the same worker. This eliminates the need for client-side reordering code.</p> <h4 id="why-this-happens"> <a href="index.html#why-this-happens" class="anchor-heading" aria-labelledby="why-this-happens"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why This Happens </h4> <p>Action Cable uses concurrent processing by design for performance.</p> <p>For strict ordering requirements, consider:</p> <ul> <li>Server-sent events (SSE) for unidirectional streaming</li> <li>WebSocket libraries with ordered stream support like <a href="https://github.com/socketry/lively/tree/main/examples/chatbot">Lively</a></li> <li>AnyCable for server-side ordering guarantees</li> </ul> <blockquote class="note"> <p><strong>Note:</strong> The async Ruby stack (Falcon + async-cable) may improve behavior but doesn’t guarantee ordering.</p> </blockquote> <h2 id="customizing-models"> <a href="index.html#customizing-models" class="anchor-heading" aria-labelledby="customizing-models"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Customizing Models </h2> <p>The <code class="language-plaintext highlighter-rouge">acts_as</code> helpers integrate seamlessly with standard Rails patterns. Add associations, validations, scopes, and callbacks as needed.</p> <h3 id="using-custom-model-names"> <a href="index.html#using-custom-model-names" class="anchor-heading" aria-labelledby="using-custom-model-names"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Custom Model Names </h3> <p>If your application uses different model names, you can configure the <code class="language-plaintext highlighter-rouge">acts_as</code> helpers accordingly:</p> <h4 class="d-inline-block" id="with-model-registry"> <a href="index.html#with-model-registry" class="anchor-heading" aria-labelledby="with-model-registry"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> With Model Registry </h4> <p class="label label-green">Available in v1.7.0+</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/conversation.rb (instead of Chat)</span>
<span class="k">class</span> <span class="nc">Conversation</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_chat</span> <span class="ss">messages: :chat_messages</span><span class="p">,</span>  <span class="c1"># Association name</span>
               <span class="ss">message_class: </span><span class="s1">'ChatMessage'</span><span class="p">,</span>  <span class="c1"># Optional if inferrable</span>
               <span class="ss">model: :ai_model</span><span class="p">,</span>
               <span class="ss">model_class: </span><span class="s1">'AiModel'</span>  <span class="c1"># Optional if inferrable</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="c1"># app/models/chat_message.rb (instead of Message)</span>
<span class="k">class</span> <span class="nc">ChatMessage</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_message</span> <span class="ss">chat: :conversation</span><span class="p">,</span>  <span class="c1"># Association name</span>
                  <span class="ss">chat_class: </span><span class="s1">'Conversation'</span><span class="p">,</span>  <span class="c1"># Optional if inferrable</span>
                  <span class="ss">tool_calls: :ai_tool_calls</span><span class="p">,</span>
                  <span class="ss">tool_call_class: </span><span class="s1">'AIToolCall'</span><span class="p">,</span>  <span class="c1"># Required for non-standard naming</span>
                  <span class="ss">model: :ai_model</span>
<span class="k">end</span>

<span class="c1"># app/models/ai_tool_call.rb (instead of ToolCall)</span>
<span class="k">class</span> <span class="nc">AIToolCall</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_tool_call</span> <span class="ss">message: :chat_message</span><span class="p">,</span>
                    <span class="ss">message_class: </span><span class="s1">'ChatMessage'</span><span class="p">,</span>  <span class="c1"># Optional if inferrable</span>
                    <span class="ss">result: :result</span>
<span class="k">end</span>

<span class="c1"># app/models/ai_model.rb (instead of Model)</span>
<span class="k">class</span> <span class="nc">AiModel</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_model</span> <span class="ss">chats: :conversations</span><span class="p">,</span>
                <span class="ss">chat_class: </span><span class="s1">'Conversation'</span>  <span class="c1"># Optional if inferrable</span>
<span class="k">end</span>
</code></pre></div></div> <h4 id="namespaced-models-example"> <a href="index.html#namespaced-models-example" class="anchor-heading" aria-labelledby="namespaced-models-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Namespaced Models Example </h4> <p>For namespaced models, you’ll need to specify class names explicitly:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/admin/bot_chat.rb</span>
<span class="k">module</span> <span class="nn">Admin</span>
  <span class="k">class</span> <span class="nc">BotChat</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
    <span class="n">acts_as_chat</span> <span class="ss">messages: :bot_messages</span><span class="p">,</span>
                 <span class="ss">message_class: </span><span class="s1">'Admin::BotMessage'</span>  <span class="c1"># Required for namespace</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/models/admin/bot_message.rb</span>
<span class="k">module</span> <span class="nn">Admin</span>
  <span class="k">class</span> <span class="nc">BotMessage</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
    <span class="n">acts_as_message</span> <span class="ss">chat: :bot_chat</span><span class="p">,</span>
                    <span class="ss">chat_class: </span><span class="s1">'Admin::BotChat'</span>  <span class="c1"># Required for namespace</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h4 class="d-inline-block" id="legacy-mode"> <a href="index.html#legacy-mode" class="anchor-heading" aria-labelledby="legacy-mode"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Legacy Mode </h4> <p class="label label-yellow">Pre-1.7.0 or opt-in</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/conversation.rb</span>
<span class="k">class</span> <span class="nc">Conversation</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_chat</span> <span class="ss">message_class: </span><span class="s1">'ChatMessage'</span><span class="p">,</span>
               <span class="ss">tool_call_class: </span><span class="s1">'AIToolCall'</span>
<span class="k">end</span>

<span class="c1"># app/models/chat_message.rb</span>
<span class="k">class</span> <span class="nc">ChatMessage</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_message</span> <span class="ss">chat_class: </span><span class="s1">'Conversation'</span><span class="p">,</span>
                  <span class="ss">chat_foreign_key: </span><span class="s1">'conversation_id'</span><span class="p">,</span>
                  <span class="ss">tool_call_class: </span><span class="s1">'AIToolCall'</span>
<span class="k">end</span>

<span class="c1"># app/models/ai_tool_call.rb</span>
<span class="k">class</span> <span class="nc">AIToolCall</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_tool_call</span> <span class="ss">message_class: </span><span class="s1">'ChatMessage'</span><span class="p">,</span>
                    <span class="ss">message_foreign_key: </span><span class="s1">'chat_message_id'</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="common-customizations"> <a href="index.html#common-customizations" class="anchor-heading" aria-labelledby="common-customizations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Common Customizations </h3> <p>Extend your models with standard Rails patterns:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/chat.rb</span>
<span class="k">class</span> <span class="nc">Chat</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">acts_as_chat</span>

  <span class="c1"># Add typical Rails associations</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:favorites</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>

  <span class="c1"># Add scopes</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">updated_at: :desc</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:with_responses</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">joins</span><span class="p">(</span><span class="ss">:messages</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">messages: </span><span class="p">{</span> <span class="ss">role: </span><span class="s1">'assistant'</span> <span class="p">}).</span><span class="nf">distinct</span> <span class="p">}</span>

  <span class="c1"># Add custom methods</span>
  <span class="k">def</span> <span class="nf">summary</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">last</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:content</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="s1">' ... '</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Add callbacks</span>
  <span class="n">after_create</span> <span class="ss">:notify_administrators</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">notify_administrators</span>
    <span class="c1"># Custom logic</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="next-steps"> <a href="index.html#next-steps" class="anchor-heading" aria-labelledby="next-steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Next Steps </h2> <ul> <li><a href="../chat/index.html">Chatting with AI Models</a></li> <li><a href="../tools/index.html">Using Tools</a></li> <li><a href="../streaming/index.html">Streaming Responses</a></li> <li><a href="../models/index.html">Working with Models</a></li> <li><a href="../error-handling/index.html">Error Handling</a></li> </ul> </main> <hr> <footer> Brought to you by <a href="https://paolino.me">Carmine Paolino</a>, maker of <a href="https://chatwithwork.com"><img src="https://chatwithwork.com/logotype.svg" alt="Chat with Work" class="chatwithwork-logo" style="height: 1.8em; vertical-align: middle; margin: 0 0.25em;"></a> <em style="font-size: 0.85em; opacity: 0.8;">— Claude Code for your documents</em> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
